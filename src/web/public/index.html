<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Manager - Gestion de projets Node.js</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e'
                        },
                        gray: {
                            50: '#fafafa',
                            100: '#f5f5f5',
                            200: '#e5e5e5',
                            300: '#d4d4d4',
                            400: '#a3a3a3',
                            500: '#737373',
                            600: '#525252',
                            700: '#404040',
                            800: '#262626',
                            900: '#171717'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .pulse-dot { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f5f5f5; }
        ::-webkit-scrollbar-thumb { background: #d4d4d4; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a3a3a3; }
        .log-viewer { font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.5; }
    </style>
</head>
<body class="h-full bg-gray-50 text-gray-900">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // ============================================
        // API Helper
        // ============================================
        const api = {
            async get(url) {
                const res = await fetch(url);
                return res.json();
            },
            async post(url, data = {}) {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                return res.json();
            },
            async put(url, data = {}) {
                const res = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                return res.json();
            },
            async del(url) {
                const res = await fetch(url, { method: 'DELETE' });
                return res.json();
            }
        };

        // ============================================
        // Icon Component
        // ============================================
        function Icon({ name, size = 18, className = '' }) {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current) {
                    ref.current.innerHTML = '';
                    // Convertir kebab-case en PascalCase pour Lucide
                    const iconName = name.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join('');
                    const iconElement = lucide.icons[iconName];
                    if (iconElement) {
                        const el = lucide.createElement(iconElement);
                        el.setAttribute('width', size);
                        el.setAttribute('height', size);
                        if (className) {
                            className.split(' ').forEach(c => { if(c) el.classList.add(c); });
                        }
                        ref.current.appendChild(el);
                    }
                }
            }, [name, size, className]);
            return <span ref={ref} className="inline-flex items-center" />;
        }

        // ============================================
        // Toast Notification
        // ============================================
        function Toast({ message, type, onClose }) {
            useEffect(() => {
                const timer = setTimeout(onClose, 4000);
                return () => clearTimeout(timer);
            }, []);

            const colors = {
                success: 'bg-emerald-50 border-emerald-200 text-emerald-700',
                error: 'bg-red-50 border-red-200 text-red-700',
                info: 'bg-blue-50 border-blue-200 text-blue-700'
            };

            return (
                <div className={`fixed top-4 right-4 z-50 px-4 py-3 rounded-lg border ${colors[type]} fade-in flex items-center gap-2 shadow-lg`}>
                    <Icon name={type === 'success' ? 'check-circle' : type === 'error' ? 'alert-circle' : 'info'} size={16} />
                    <span className="text-sm font-medium">{message}</span>
                    <button onClick={onClose} className="ml-2 opacity-60 hover:opacity-100">
                        <Icon name="x" size={14} />
                    </button>
                </div>
            );
        }

        // ============================================
        // Modal
        // ============================================
        function Modal({ title, children, onClose, wide = false }) {
            const mouseDownTarget = useRef(null);
            return (
                <div
                    className="fixed inset-0 z-40 flex items-center justify-center bg-black/40 backdrop-blur-sm fade-in"
                    onMouseDown={e => { mouseDownTarget.current = e.target; }}
                    onMouseUp={e => { if (mouseDownTarget.current === e.currentTarget && e.target === e.currentTarget) onClose(); }}
                >
                    <div className={`bg-white border border-gray-200 rounded-xl shadow-2xl ${wide ? 'w-full max-w-3xl' : 'w-full max-w-lg'} max-h-[90vh] overflow-y-auto mx-4`} onMouseDown={e => e.stopPropagation()}>
                        <div className="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                            <h2 className="text-lg font-semibold text-gray-900">{title}</h2>
                            <button onClick={onClose} className="p-1 rounded-lg hover:bg-gray-100 text-gray-400 hover:text-gray-600 transition-colors">
                                <Icon name="x" size={20} />
                            </button>
                        </div>
                        <div className="p-6">{children}</div>
                    </div>
                </div>
            );
        }

        // ============================================
        // Confirm Dialog
        // ============================================
        function ConfirmDialog({ title, message, onConfirm, onCancel, danger = false }) {
            return (
                <Modal title={title} onClose={onCancel}>
                    <p className="text-gray-600 mb-6">{message}</p>
                    <div className="flex justify-end gap-3">
                        <button onClick={onCancel} className="px-4 py-2 rounded-lg bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 transition-colors">
                            Annuler
                        </button>
                        <button onClick={onConfirm} className={`px-4 py-2 rounded-lg text-white transition-colors ${danger ? 'bg-red-600 hover:bg-red-700' : 'bg-primary-600 hover:bg-primary-700'}`}>
                            Confirmer
                        </button>
                    </div>
                </Modal>
            );
        }

        // ============================================
        // Status Badge
        // ============================================
        function StatusBadge({ status }) {
            const isOnline = status === 'online';
            return (
                <span className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium ${isOnline ? 'bg-emerald-50 text-emerald-700 border border-emerald-200' : 'bg-gray-100 text-gray-600 border border-gray-200'}`}>
                    <span className={`w-1.5 h-1.5 rounded-full ${isOnline ? 'bg-emerald-500 pulse-dot' : 'bg-gray-400'}`}></span>
                    {isOnline ? 'En ligne' : 'Arrêté'}
                </span>
            );
        }

        // ============================================
        // Sidebar
        // ============================================
        function Sidebar({ currentPage, onNavigate, projectCount, currentUser, onLogout }) {
            const isAdmin = currentUser?.role === 'admin';
            
            const links = [
                { id: 'dashboard', icon: 'layout-dashboard', label: 'Tableau de bord' },
                { id: 'projects', icon: 'folder-open', label: 'Projets' },
                { id: 'databases', icon: 'database', label: 'Bases de données' },
                ...(isAdmin ? [
                    { id: 'users', icon: 'users', label: 'Utilisateurs' },
                    { id: 'pm2', icon: 'activity', label: 'Statut PM2' },
                ] : []),
            ];

            return (
                <aside className="w-64 bg-white border-r border-gray-200 flex flex-col h-full">
                    <div className="px-6 py-5 border-b border-gray-200">
                        <div className="flex items-center gap-3">
                            <div className="w-9 h-9 bg-primary-600 rounded-lg flex items-center justify-center">
                                <Icon name="server" size={18} className="text-white" />
                            </div>
                            <div>
                                <h1 className="text-sm font-bold text-gray-900">Project Manager</h1>
                                <p className="text-xs text-gray-500">Node.js + SFTP + PM2</p>
                            </div>
                        </div>
                    </div>

                    <div className="px-4 py-3 border-b border-gray-200">
                        <div className="flex items-center gap-2">
                            <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${isAdmin ? 'bg-primary-50' : 'bg-emerald-50'}`}>
                                <Icon name={isAdmin ? 'shield-check' : 'user'} size={16} className={isAdmin ? 'text-primary-600' : 'text-emerald-600'} />
                            </div>
                            <div className="flex-1 min-w-0">
                                <p className="text-sm font-medium text-gray-900 truncate">{currentUser?.username}</p>
                                <p className="text-xs text-gray-500 capitalize">{currentUser?.role}</p>
                            </div>
                        </div>
                    </div>

                    <nav className="flex-1 px-3 py-4 space-y-1">
                        {links.map(link => (
                            <button
                                key={link.id}
                                onClick={() => onNavigate(link.id)}
                                className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm transition-all ${
                                    currentPage === link.id
                                        ? 'bg-primary-50 text-primary-700 font-medium'
                                        : 'text-gray-600 hover:text-gray-900 hover:bg-gray-50'
                                }`}
                            >
                                <Icon name={link.icon} size={18} />
                                <span>{link.label}</span>
                                {link.id === 'projects' && projectCount > 0 && (
                                    <span className="ml-auto bg-gray-100 text-gray-700 text-xs px-2 py-0.5 rounded-full">{projectCount}</span>
                                )}
                            </button>
                        ))}
                    </nav>

                    <div className="px-4 py-4 border-t border-gray-200 space-y-3">
                        <button
                            onClick={onLogout}
                            className="w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm text-gray-600 hover:text-red-600 hover:bg-red-50 transition-colors"
                        >
                            <Icon name="log-out" size={16} />
                            <span>Déconnexion</span>
                        </button>
                        <p className="text-xs text-gray-400 text-center">v1.0.0 — Ubuntu 22.04</p>
                    </div>
                </aside>
            );
        }

        // ============================================
        // Login Page
        // ============================================
        function LoginPage({ onLogin, showToast }) {
            const [selectedRole, setSelectedRole] = useState(null);
            const [form, setForm] = useState({ username: '', password: '' });
            const [loading, setLoading] = useState(false);

            async function handleSubmit(e) {
                e.preventDefault();
                setLoading(true);
                const result = await api.post('/api/auth/login', form);
                setLoading(false);
                
                if (result.success) {
                    // Vérifier que le rôle correspond
                    if (result.user.role !== selectedRole) {
                        showToast(`Ce compte n'est pas un compte ${selectedRole === 'admin' ? 'administrateur' : 'utilisateur'}`, 'error');
                        return;
                    }
                    onLogin(result.user);
                } else {
                    showToast(result.error, 'error');
                }
            }

            // Étape 1 : Sélection du rôle
            if (!selectedRole) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-50 px-4">
                        <div className="max-w-4xl w-full fade-in">
                            <div className="text-center mb-12">
                                <div className="w-20 h-20 bg-primary-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg">
                                    <Icon name="server" size={40} className="text-white" />
                                </div>
                                <h1 className="text-4xl font-bold text-gray-900 mb-3">Project Manager</h1>
                                <p className="text-gray-600 text-lg">Sélectionnez votre type de compte</p>
                            </div>

                            <div className="grid md:grid-cols-2 gap-6">
                                <button
                                    onClick={() => setSelectedRole('admin')}
                                    className="group relative bg-white hover:bg-gray-50 border-2 border-gray-200 hover:border-primary-300 rounded-2xl p-10 transition-all duration-300 hover:scale-105 hover:shadow-xl"
                                >
                                    <div className="flex flex-col items-center text-center">
                                        <div className="w-20 h-20 bg-primary-50 group-hover:bg-primary-100 rounded-xl flex items-center justify-center mb-6 transition-colors">
                                            <Icon name="shield-check" size={40} className="text-primary-600" />
                                        </div>
                                        <h2 className="text-2xl font-bold text-gray-900 mb-3">Je suis un admin</h2>
                                        <p className="text-gray-600 group-hover:text-gray-700 transition-colors">
                                            Accès complet à la gestion des projets, services et utilisateurs
                                        </p>
                                        <div className="mt-6 flex items-center gap-2 text-primary-600 group-hover:text-primary-700 transition-colors">
                                            <span className="text-sm font-medium">Continuer</span>
                                            <Icon name="arrow-right" size={18} />
                                        </div>
                                    </div>
                                </button>

                                <button
                                    onClick={() => setSelectedRole('user')}
                                    className="group relative bg-white hover:bg-gray-50 border-2 border-gray-200 hover:border-emerald-300 rounded-2xl p-10 transition-all duration-300 hover:scale-105 hover:shadow-xl"
                                >
                                    <div className="flex flex-col items-center text-center">
                                        <div className="w-20 h-20 bg-emerald-50 group-hover:bg-emerald-100 rounded-xl flex items-center justify-center mb-6 transition-colors">
                                            <Icon name="user" size={40} className="text-emerald-600" />
                                        </div>
                                        <h2 className="text-2xl font-bold text-gray-900 mb-3">Je suis un utilisateur</h2>
                                        <p className="text-gray-600 group-hover:text-gray-700 transition-colors">
                                            Accès aux projets qui me sont assignés
                                        </p>
                                        <div className="mt-6 flex items-center gap-2 text-emerald-600 group-hover:text-emerald-700 transition-colors">
                                            <span className="text-sm font-medium">Continuer</span>
                                            <Icon name="arrow-right" size={18} />
                                        </div>
                                    </div>
                                </button>
                            </div>

                            <div className="mt-12 text-center">
                                <p className="text-xs text-gray-400">v1.0.0 — Ubuntu 22.04</p>
                            </div>
                        </div>
                    </div>
                );
            }

            // Étape 2 : Formulaire de connexion
            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50 px-4">
                    <div className="max-w-md w-full fade-in">
                        <button 
                            onClick={() => setSelectedRole(null)}
                            className="flex items-center gap-2 text-gray-600 hover:text-gray-900 text-sm mb-6 transition-colors"
                        >
                            <Icon name="arrow-left" size={16} /> Changer de type de compte
                        </button>

                        <div className="text-center mb-8">
                            <div className={`w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg ${selectedRole === 'admin' ? 'bg-primary-600' : 'bg-emerald-600'}`}>
                                <Icon name={selectedRole === 'admin' ? 'shield-check' : 'user'} size={40} className="text-white" />
                            </div>
                            <h1 className="text-3xl font-bold text-gray-900 mb-2">
                                Connexion {selectedRole === 'admin' ? 'Admin' : 'Utilisateur'}
                            </h1>
                            <p className="text-gray-600">Entrez vos identifiants</p>
                        </div>

                        <form onSubmit={handleSubmit} className="bg-white border border-gray-200 rounded-xl p-8 space-y-5 shadow-sm">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                                    <Icon name="user" size={14} /> Nom d'utilisateur
                                </label>
                                <input
                                    type="text"
                                    value={form.username}
                                    onChange={e => setForm({...form, username: e.target.value})}
                                    placeholder={selectedRole === 'admin' ? 'admin' : 'utilisateur'}
                                    required
                                    className="w-full px-4 py-2.5 bg-white border border-gray-300 rounded-lg text-gray-900 placeholder-gray-400 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 transition-colors"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                                    <Icon name="lock" size={14} /> Mot de passe
                                </label>
                                <input
                                    type="password"
                                    value={form.password}
                                    onChange={e => setForm({...form, password: e.target.value})}
                                    placeholder="••••••••"
                                    required
                                    className="w-full px-4 py-2.5 bg-white border border-gray-300 rounded-lg text-gray-900 placeholder-gray-400 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 transition-colors"
                                />
                            </div>

                            <button
                                type="submit"
                                disabled={loading}
                                className={`w-full py-3 rounded-lg disabled:bg-gray-200 disabled:text-gray-400 text-white font-medium transition-colors flex items-center justify-center gap-2 ${selectedRole === 'admin' ? 'bg-primary-600 hover:bg-primary-700' : 'bg-emerald-600 hover:bg-emerald-700'}`}
                            >
                                {loading ? (
                                    <><Icon name="loader-2" size={18} className="animate-spin" /> Connexion...</>
                                ) : (
                                    <><Icon name="log-in" size={18} /> Se connecter</>
                                )}
                            </button>
                        </form>

                        <div className="mt-8 text-center">
                            <p className="text-xs text-gray-500">Compte admin par défaut : admin / admin123</p>
                            <p className="text-xs text-gray-400 mt-2">v1.0.0 — Ubuntu 22.04</p>
                        </div>
                    </div>
                </div>
            );
        }

        // ============================================
        // Dashboard Page
        // ============================================
        function DashboardPage({ projects, onNavigate, onRefresh, showToast, currentUser }) {
            const isAdmin = currentUser?.role === 'admin';
            const totalServices = projects.reduce((acc, p) => acc + (p.totalServices || 0), 0);
            const runningServices = projects.reduce((acc, p) => acc + (p.runningServices || 0), 0);

            const stats = [
                { label: 'Projets', value: projects.length, icon: 'folder-open', color: 'blue' },
                { label: 'Services', value: totalServices, icon: 'boxes', color: 'purple' },
                { label: 'En ligne', value: runningServices, icon: 'check-circle', color: 'emerald' },
                { label: 'Arrêtés', value: totalServices - runningServices, icon: 'circle-off', color: 'red' },
            ];

            const colorMap = {
                blue: 'bg-primary-50 text-primary-600',
                purple: 'bg-purple-50 text-purple-600',
                emerald: 'bg-emerald-50 text-emerald-600',
                red: 'bg-red-50 text-red-600',
            };

            async function handleRegenerateAll() {
                const result = await api.post('/api/regenerate-all-scripts');
                showToast(result.success ? 'Scripts régénérés' : result.error, result.success ? 'success' : 'error');
            }

            return (
                <div className="fade-in">
                    <div className="flex items-center justify-between mb-8">
                        <div>
                            <h1 className="text-2xl font-bold text-gray-900">Tableau de bord</h1>
                            <p className="text-gray-600 mt-1">
                                {isAdmin ? 'Vue d\'ensemble de tous les projets et services' : 'Vos projets assignés'}
                            </p>
                        </div>
                        {isAdmin && (
                            <div className="flex gap-2">
                                <button onClick={handleRegenerateAll} className="flex items-center gap-2 px-4 py-2 rounded-lg bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 transition-colors text-sm">
                                    <Icon name="refresh-cw" size={15} />
                                    Régénérer scripts
                                </button>
                                <button onClick={() => onNavigate('create-project')} className="flex items-center gap-2 px-4 py-2 rounded-lg bg-primary-600 hover:bg-primary-700 text-white transition-colors text-sm font-medium">
                                    <Icon name="plus" size={15} />
                                    Nouveau projet
                                </button>
                            </div>
                        )}
                    </div>

                    <div className="grid grid-cols-4 gap-4 mb-8">
                        {stats.map((stat, i) => (
                            <div key={i} className="bg-white border border-gray-200 rounded-xl p-5 shadow-sm">
                                <div className="flex items-center justify-between mb-3">
                                    <span className="text-gray-600 text-sm">{stat.label}</span>
                                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${colorMap[stat.color]}`}>
                                        <Icon name={stat.icon} size={16} />
                                    </div>
                                </div>
                                <p className="text-3xl font-bold text-gray-900">{stat.value}</p>
                            </div>
                        ))}
                    </div>

                    <div className="bg-white border border-gray-200 rounded-xl shadow-sm">
                        <div className="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                            <h2 className="font-semibold text-gray-900">Projets récents</h2>
                            <button onClick={() => onNavigate('projects')} className="text-sm text-primary-600 hover:text-primary-700 transition-colors">
                                Voir tout →
                            </button>
                        </div>
                        {projects.length === 0 ? (
                            <div className="px-6 py-12 text-center">
                                <Icon name="folder-plus" size={40} className="text-gray-300 mx-auto mb-3" />
                                <p className="text-gray-600">Aucun projet configuré</p>
                                <button onClick={() => onNavigate('create-project')} className="mt-3 text-sm text-primary-600 hover:text-primary-700">
                                    Créer votre premier projet →
                                </button>
                            </div>
                        ) : (
                            <div className="divide-y divide-gray-200">
                                {projects.slice(0, 5).map(project => (
                                    <button
                                        key={project.name}
                                        onClick={() => onNavigate('project-detail', project.name)}
                                        className="w-full flex items-center justify-between px-6 py-4 hover:bg-gray-50 transition-colors text-left">
                                        <div className="flex items-center gap-4">
                                            <div className="w-10 h-10 bg-primary-50 rounded-lg flex items-center justify-center">
                                                <Icon name="folder" size={18} className="text-primary-600" />
                                            </div>
                                            <div>
                                                <p className="font-medium text-gray-900">{project.name}</p>
                                                <p className="text-xs text-gray-500">SFTP: {project.sftpUser || '-'}</p>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-4">
                                            <span className="text-sm text-gray-600">
                                                {project.runningServices}/{project.totalServices} services
                                            </span>
                                            <StatusBadge status={project.runningServices > 0 ? 'online' : 'stopped'} />
                                            <Icon name="chevron-right" size={16} className="text-gray-400" />
                                        </div>
                                    </button>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // ============================================
        // Projects List Page
        // ============================================
        function ProjectsPage({ projects, onNavigate, onRefresh, showToast }) {
            const [deleteTarget, setDeleteTarget] = useState(null);

            async function handleDelete() {
                if (!deleteTarget) return;
                const result = await api.del(`/api/projects/${deleteTarget}?deleteFiles=false`);
                showToast(result.success ? `Projet ${deleteTarget} supprimé` : result.error, result.success ? 'success' : 'error');
                setDeleteTarget(null);
                onRefresh();
            }

            return (
                <div className="fade-in">
                    <div className="flex items-center justify-between mb-8">
                        <div>
                            <h1 className="text-2xl font-bold text-gray-900">Projets</h1>
                            <p className="text-gray-600 mt-1">{projects.length} projet(s) configuré(s)</p>
                        </div>
                        <button onClick={() => onNavigate('create-project')} className="flex items-center gap-2 px-4 py-2 rounded-lg bg-primary-600 hover:bg-primary-700 text-white transition-colors text-sm font-medium">
                            <Icon name="plus" size={15} />
                            Nouveau projet
                        </button>
                    </div>

                    {projects.length === 0 ? (
                        <div className="bg-white border border-gray-200 rounded-xl px-6 py-16 text-center shadow-sm">
                            <Icon name="folder-plus" size={48} className="text-gray-300 mx-auto mb-4" />
                            <p className="text-gray-900 text-lg mb-2">Aucun projet</p>
                            <p className="text-gray-600 text-sm mb-4">Commencez par créer votre premier projet Node.js</p>
                            <button onClick={() => onNavigate('create-project')} className="px-4 py-2 rounded-lg bg-primary-600 hover:bg-primary-700 text-white text-sm font-medium transition-colors">
                                Créer un projet
                            </button>
                        </div>
                    ) : (
                        <div className="grid gap-4">
                            {projects.map(project => (
                                <div key={project.name} className="bg-white border border-gray-200 rounded-xl p-5 hover:border-gray-300 hover:shadow-md transition-all">
                                    <div className="flex items-center justify-between">
                                        <button onClick={() => onNavigate('project-detail', project.name)} className="flex items-center gap-4 text-left flex-1">
                                            <div className="w-12 h-12 bg-primary-50 rounded-xl flex items-center justify-center">
                                                <Icon name="folder" size={22} className="text-primary-600" />
                                            </div>
                                            <div>
                                                <h3 className="font-semibold text-gray-900 text-lg">{project.name}</h3>
                                                <div className="flex items-center gap-4 mt-1">
                                                    <span className="text-xs text-gray-500 flex items-center gap-1">
                                                        <Icon name="user" size={12} /> {project.sftpUser || '-'}
                                                    </span>
                                                    <span className="text-xs text-gray-500 flex items-center gap-1">
                                                        <Icon name="boxes" size={12} /> {project.totalServices} service(s)
                                                    </span>
                                                    <span className="text-xs text-gray-500 flex items-center gap-1">
                                                        <Icon name="calendar" size={12} /> {new Date(project.createdAt).toLocaleDateString('fr-FR')}
                                                    </span>
                                                </div>
                                            </div>
                                        </button>
                                        <div className="flex items-center gap-3">
                                            <StatusBadge status={project.runningServices > 0 ? 'online' : 'stopped'} />
                                            <span className="text-sm text-gray-600 min-w-[80px] text-right">
                                                {project.runningServices}/{project.totalServices} actifs
                                            </span>
                                            <button
                                                onClick={() => setDeleteTarget(project.name)}
                                                className="p-2 rounded-lg hover:bg-red-50 text-gray-400 hover:text-red-600 transition-colors"
                                                title="Supprimer"
                                            >
                                                <Icon name="trash-2" size={16} />
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {deleteTarget && (
                        <ConfirmDialog
                            title="Supprimer le projet"
                            message={`Êtes-vous sûr de vouloir supprimer le projet "${deleteTarget}" ? L'utilisateur SFTP sera supprimé. Les fichiers du projet seront conservés.`}
                            onConfirm={handleDelete}
                            onCancel={() => setDeleteTarget(null)}
                            danger
                        />
                    )}
                </div>
            );
        }

        // ============================================
        // Create Project Page
        // ============================================
        function CreateProjectPage({ onNavigate, onRefresh, showToast }) {
            const [form, setForm] = useState({ name: '', password: '', confirmPassword: '' });
            const [loading, setLoading] = useState(false);

            async function handleSubmit(e) {
                e.preventDefault();
                if (form.password !== form.confirmPassword) {
                    showToast('Les mots de passe ne correspondent pas', 'error');
                    return;
                }
                setLoading(true);
                const result = await api.post('/api/projects', { name: form.name, password: form.password });
                setLoading(false);
                if (result.success) {
                    showToast(`Projet "${form.name}" créé avec succès`, 'success');
                    onRefresh();
                    onNavigate('project-detail', form.name);
                } else {
                    showToast(result.error, 'error');
                }
            }

            return (
                <div className="fade-in max-w-xl">
                    <button onClick={() => onNavigate('projects')} className="flex items-center gap-1 text-gray-600 hover:text-gray-900 text-sm mb-6 transition-colors">
                        <Icon name="arrow-left" size={16} /> Retour aux projets
                    </button>

                    <h1 className="text-2xl font-bold text-gray-900 mb-2">Nouveau projet</h1>
                    <p className="text-gray-600 mb-8">Créez un projet avec un utilisateur SFTP chroot dédié</p>

                    <form onSubmit={handleSubmit} className="bg-white border border-gray-200 rounded-xl p-6 space-y-5 shadow-sm">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                                <Icon name="folder" size={14} /> Nom du projet
                            </label>
                            <input
                                type="text"
                                value={form.name}
                                onChange={e => setForm({...form, name: e.target.value})}
                                placeholder="mon-projet"
                                pattern="^[a-zA-Z][a-zA-Z0-9_-]*$"
                                required
                                className="w-full px-4 py-2.5 bg-white border border-gray-300 rounded-lg text-gray-900 placeholder-gray-400 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 transition-colors"
                            />
                            <p className="text-xs text-gray-500 mt-1.5">Lettres, chiffres, tirets et underscores uniquement</p>
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                                <Icon name="key" size={14} /> Mot de passe SFTP
                            </label>
                            <input
                                type="password"
                                value={form.password}
                                onChange={e => setForm({...form, password: e.target.value})}
                                placeholder="••••••••"
                                minLength={8}
                                required
                                className="w-full px-4 py-2.5 bg-white border border-gray-300 rounded-lg text-gray-900 placeholder-gray-400 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 transition-colors"
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                                <Icon name="shield-check" size={14} /> Confirmer le mot de passe
                            </label>
                            <input
                                type="password"
                                value={form.confirmPassword}
                                onChange={e => setForm({...form, confirmPassword: e.target.value})}
                                placeholder="••••••••"
                                minLength={8}
                                required
                                className="w-full px-4 py-2.5 bg-white border border-gray-300 rounded-lg text-gray-900 placeholder-gray-400 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 transition-colors"
                            />
                        </div>

                        <div className="bg-gray-50 rounded-lg p-4 border border-gray-200">
                            <p className="text-xs text-gray-600">
                                <strong className="text-gray-700 flex items-center gap-2 mb-2">
                                    <Icon name="info" size={14} /> Ce qui sera créé :
                                </strong>
                                • Dossier projet : <code className="text-primary-600">/var/www/{form.name || '...'}</code><br/>
                                • Utilisateur SFTP : <code className="text-primary-600">sftp_{form.name || '...'}</code><br/>
                                • Dossier sites : <code className="text-primary-600">/var/www/{form.name || '...'}/sites</code><br/>
                                • Scripts start/stop/restart/status
                            </p>
                        </div>

                        <button
                            type="submit"
                            disabled={loading}
                            className="w-full py-2.5 rounded-lg bg-primary-600 hover:bg-primary-700 disabled:bg-gray-200 disabled:text-gray-400 text-white font-medium transition-colors flex items-center justify-center gap-2"
                        >
                            {loading ? (
                                <><Icon name="loader-2" size={16} className="animate-spin" /> Création en cours...</>
                            ) : (
                                <><Icon name="plus" size={16} /> Créer le projet</>
                            )}
                        </button>
                    </form>
                </div>
            );
        }

        // ============================================
        // Project Detail Page
        // ============================================
        function ProjectDetailPage({ projectName, onNavigate, onRefresh, showToast }) {
            const [project, setProject] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('services');
            const [showAddService, setShowAddService] = useState(false);
            const [showEditService, setShowEditService] = useState(null);
            const [showLogs, setShowLogs] = useState(null);
            const [showChangePassword, setShowChangePassword] = useState(false);
            const [deleteServiceTarget, setDeleteServiceTarget] = useState(null);
            const [actionLoading, setActionLoading] = useState(null);
            const [projectDatabase, setProjectDatabase] = useState(null);

            const loadProject = useCallback(async () => {
                const result = await api.get(`/api/projects/${projectName}`);
                if (result.success) {
                    setProject(result.data);
                    loadProjectDatabase();
                }
                setLoading(false);
            }, [projectName]);

            const loadProjectDatabase = async () => {
                const result = await api.get('/api/databases');
                if (result.success) {
                    const db = result.data.find(d => d.projectName === projectName);
                    setProjectDatabase(db);
                }
            };

            useEffect(() => { loadProject(); }, [loadProject]);

            async function handleServiceAction(serviceName, action) {
                setActionLoading(`${serviceName}-${action}`);
                const result = await api.post(`/api/projects/${projectName}/services/${serviceName}/${action}`);
                showToast(result.success ? result.message : result.error, result.success ? 'success' : 'error');
                setActionLoading(null);
                loadProject();
            }

            async function handleStartAll() {
                setActionLoading('start-all');
                const result = await api.post(`/api/projects/${projectName}/services-start-all`, { runSetup: false });
                showToast(result.success ? result.message : result.error, result.success ? 'success' : 'error');
                setActionLoading(null);
                loadProject();
            }

            async function handleStopAll() {
                setActionLoading('stop-all');
                const result = await api.post(`/api/projects/${projectName}/services-stop-all`);
                showToast(result.success ? result.message : result.error, result.success ? 'success' : 'error');
                setActionLoading(null);
                loadProject();
            }

            async function handleRegenerateScripts() {
                const result = await api.post(`/api/projects/${projectName}/regenerate-scripts`);
                showToast(result.success ? 'Scripts régénérés' : result.error, result.success ? 'success' : 'error');
            }

            async function handleDeleteService() {
                if (!deleteServiceTarget) return;
                const result = await api.del(`/api/projects/${projectName}/services/${deleteServiceTarget}`);
                showToast(result.success ? 'Service supprimé' : result.error, result.success ? 'success' : 'error');
                setDeleteServiceTarget(null);
                loadProject();
            }

            if (loading) {
                return (
                    <div className="flex items-center justify-center h-64">
                        <div className="text-center">
                            <Icon name="loader-2" size={36} className="animate-spin text-primary-400 mx-auto mb-3" />
                            <p className="text-sm text-gray-500">Chargement du projet...</p>
                        </div>
                    </div>
                );
            }

            if (!project) {
                return (
                    <div className="text-center py-16">
                        <Icon name="folder-x" size={48} className="text-gray-300 mx-auto mb-4" />
                        <p className="text-gray-600 text-lg">Projet non trouvé</p>
                        <button onClick={() => onNavigate('projects')} className="mt-4 text-sm text-primary-600 hover:text-primary-700">← Retour aux projets</button>
                    </div>
                );
            }

            const svcList = project.services || [];
            const onlineCount = svcList.filter(s => s.status === 'online').length;
            const totalMemory = svcList.reduce((acc, s) => acc + (s.memory || 0), 0);
            const tabs = [
                { id: 'services', label: 'Services', icon: 'boxes', count: svcList.length },
                { id: 'info', label: 'Informations', icon: 'info' },
                { id: 'scripts', label: 'Scripts', icon: 'terminal' },
            ];

            return (
                <div className="fade-in">
                    <button onClick={() => onNavigate('projects')} className="flex items-center gap-1.5 text-gray-500 hover:text-gray-900 text-sm mb-5 transition-colors">
                        <Icon name="arrow-left" size={15} /> Retour aux projets
                    </button>

                    {/* Hero Header */}
                    <div className="bg-white border border-gray-200 rounded-2xl p-6 mb-5 shadow-sm">
                        <div className="flex items-start justify-between gap-4 flex-wrap">
                            <div className="flex items-center gap-4">
                                <div className="w-16 h-16 bg-gradient-to-br from-primary-500 to-primary-700 rounded-2xl flex items-center justify-center shadow-lg shrink-0">
                                    <Icon name="folder-open" size={30} className="text-white" />
                                </div>
                                <div>
                                    <h1 className="text-2xl font-bold text-gray-900">{project.config?.name || projectName}</h1>
                                    <div className="flex flex-wrap items-center gap-2 mt-2">
                                        <span className="text-xs text-gray-500 flex items-center gap-1.5 bg-gray-50 border border-gray-200 px-2.5 py-1 rounded-full">
                                            <Icon name="map-pin" size={11} /> /var/www/{projectName}
                                        </span>
                                        <span className="text-xs text-gray-500 flex items-center gap-1.5 bg-gray-50 border border-gray-200 px-2.5 py-1 rounded-full">
                                            <Icon name="user" size={11} /> {project.sftpUser || project.config?.sftpUser || '-'}
                                        </span>
                                        {project.config?.createdAt && (
                                            <span className="text-xs text-gray-500 flex items-center gap-1.5 bg-gray-50 border border-gray-200 px-2.5 py-1 rounded-full">
                                                <Icon name="calendar" size={11} /> {new Date(project.config.createdAt).toLocaleDateString('fr-FR')}
                                            </span>
                                        )}
                                    </div>
                                </div>
                            </div>
                            <div className="flex flex-wrap gap-2 shrink-0">
                                {projectDatabase && (
                                    <button onClick={() => onNavigate('database-editor', projectDatabase.id)} className="flex items-center gap-2 px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white transition-colors text-sm font-medium shadow-sm">
                                        <Icon name="database" size={14} /> {projectDatabase.name}
                                    </button>
                                )}
                                <button onClick={() => onNavigate('sftp-browser', projectName)} className="flex items-center gap-2 px-3 py-2 rounded-xl bg-primary-600 hover:bg-primary-700 text-white transition-colors text-sm font-medium shadow-sm">
                                    <Icon name="hard-drive" size={14} /> SFTP
                                </button>
                                <button onClick={() => setShowChangePassword(true)} className="flex items-center gap-2 px-3 py-2 rounded-xl bg-white hover:bg-gray-50 text-gray-700 border border-gray-200 transition-colors text-sm">
                                    <Icon name="key" size={14} /> Mot de passe
                                </button>
                                <button onClick={handleRegenerateScripts} className="p-2 rounded-xl bg-white hover:bg-gray-50 text-gray-500 border border-gray-200 transition-colors" title="Régénérer les scripts">
                                    <Icon name="refresh-cw" size={16} />
                                </button>
                            </div>
                        </div>
                        <div className="grid grid-cols-4 gap-3 mt-5 pt-5 border-t border-gray-100">
                            {[
                                { label: 'Services', value: svcList.length, color: 'text-gray-900' },
                                { label: 'En ligne', value: onlineCount, color: 'text-emerald-600' },
                                { label: 'Arrêtés', value: svcList.length - onlineCount, color: 'text-red-500' },
                                { label: totalMemory > 0 ? 'MB RAM' : 'RAM', value: totalMemory > 0 ? Math.round(totalMemory / 1024 / 1024) : '—', color: 'text-purple-600' },
                            ].map((stat, i) => (
                                <div key={i} className="text-center py-1">
                                    <p className={`text-2xl font-bold ${stat.color}`}>{stat.value}</p>
                                    <p className="text-xs text-gray-500 mt-0.5">{stat.label}</p>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Tabs */}
                    <div className="flex gap-1 bg-gray-100 p-1 rounded-xl mb-5 w-fit">
                        {tabs.map(tab => (
                            <button key={tab.id} onClick={() => setActiveTab(tab.id)}
                                className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all ${activeTab === tab.id ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>
                                <Icon name={tab.icon} size={15} />
                                {tab.label}
                                {tab.count !== undefined && (
                                    <span className={`text-xs px-1.5 py-0.5 rounded-full ${activeTab === tab.id ? 'bg-primary-100 text-primary-700' : 'bg-gray-200 text-gray-600'}`}>{tab.count}</span>
                                )}
                            </button>
                        ))}
                    </div>

                    {/* Tab: Services */}
                    {activeTab === 'services' && (
                        <div className="bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden">
                            <div className="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                                <h2 className="font-semibold text-gray-900 flex items-center gap-2">
                                    <Icon name="boxes" size={17} className="text-primary-600" /> Services
                                </h2>
                                <div className="flex gap-2">
                                    {svcList.length > 0 && (
                                        <>
                                            <button onClick={handleStartAll} disabled={actionLoading === 'start-all'} className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-emerald-50 text-emerald-700 hover:bg-emerald-100 text-xs font-medium transition-colors disabled:opacity-50">
                                                <Icon name="play" size={13} /> Tout démarrer
                                            </button>
                                            <button onClick={handleStopAll} disabled={actionLoading === 'stop-all'} className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-red-50 text-red-700 hover:bg-red-100 text-xs font-medium transition-colors disabled:opacity-50">
                                                <Icon name="square" size={13} /> Tout arrêter
                                            </button>
                                        </>
                                    )}
                                    <button onClick={() => setShowAddService(true)} className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-primary-600 hover:bg-primary-700 text-white text-xs font-medium transition-colors">
                                        <Icon name="plus" size={13} /> Ajouter
                                    </button>
                                </div>
                            </div>
                            {svcList.length === 0 ? (
                                <div className="px-6 py-16 text-center">
                                    <div className="w-16 h-16 bg-gray-50 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                        <Icon name="package" size={32} className="text-gray-300" />
                                    </div>
                                    <p className="text-gray-700 font-medium mb-1">Aucun service configuré</p>
                                    <p className="text-gray-500 text-sm mb-4">Ajoutez votre premier service pour démarrer</p>
                                    <button onClick={() => setShowAddService(true)} className="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-primary-600 hover:bg-primary-700 text-white text-sm font-medium transition-colors">
                                        <Icon name="plus" size={14} /> Ajouter un service
                                    </button>
                                </div>
                            ) : (
                                <div className="divide-y divide-gray-100">
                                    {svcList.map(svc => (
                                        <div key={svc.name} className="px-6 py-4 hover:bg-gray-50/70 transition-colors group">
                                            <div className="flex items-center justify-between gap-4">
                                                <div className="flex items-center gap-4 flex-1 min-w-0">
                                                    <StatusBadge status={svc.status} />
                                                    <div className="min-w-0">
                                                        <p className="font-semibold text-gray-900">{svc.name}</p>
                                                        <div className="flex flex-wrap items-center gap-2 mt-1">
                                                            <code className="text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded font-mono">{svc.command}</code>
                                                            {svc.directory && <span className="text-xs text-gray-400 flex items-center gap-1"><Icon name="folder" size={11} />{svc.directory}</span>}
                                                            {svc.description && <span className="text-xs text-gray-400 italic">{svc.description}</span>}
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-3 shrink-0">
                                                    {svc.pid && <span className="text-xs text-gray-400 hidden lg:block">PID {svc.pid}</span>}
                                                    {svc.memory > 0 && <span className="text-xs text-gray-400 hidden lg:block">{Math.round(svc.memory / 1024 / 1024)} MB</span>}
                                                    {svc.restarts > 0 && <span className="text-xs text-amber-600 font-medium">{svc.restarts}↺</span>}
                                                    <div className="flex gap-0.5">
                                                        {svc.status !== 'online' ? (
                                                            <>
                                                                <button onClick={() => handleServiceAction(svc.name, 'setup')} disabled={actionLoading === `${svc.name}-setup`} className="p-1.5 rounded-lg hover:bg-amber-50 text-gray-400 hover:text-amber-600 transition-colors" title="Setup uniquement"><Icon name="settings" size={15} /></button>
                                                                <button onClick={() => handleServiceAction(svc.name, 'start-only')} disabled={actionLoading === `${svc.name}-start-only`} className="p-1.5 rounded-lg hover:bg-blue-50 text-gray-400 hover:text-blue-600 transition-colors" title="Démarrer sans setup"><Icon name="play" size={15} /></button>
                                                                <button onClick={() => handleServiceAction(svc.name, 'start')} disabled={actionLoading === `${svc.name}-start`} className="p-1.5 rounded-lg hover:bg-emerald-50 text-gray-400 hover:text-emerald-600 transition-colors" title="Setup + Démarrer"><Icon name="play-circle" size={15} /></button>
                                                            </>
                                                        ) : (
                                                            <>
                                                                <button onClick={() => handleServiceAction(svc.name, 'stop')} disabled={actionLoading === `${svc.name}-stop`} className="p-1.5 rounded-lg hover:bg-red-50 text-gray-400 hover:text-red-600 transition-colors" title="Arrêter"><Icon name="square" size={15} /></button>
                                                                <button onClick={() => handleServiceAction(svc.name, 'restart')} disabled={actionLoading === `${svc.name}-restart`} className="p-1.5 rounded-lg hover:bg-blue-50 text-gray-400 hover:text-blue-600 transition-colors" title="Redémarrer"><Icon name="refresh-cw" size={15} /></button>
                                                            </>
                                                        )}
                                                        <button onClick={() => setShowLogs(svc.name)} className="p-1.5 rounded-lg hover:bg-purple-50 text-gray-400 hover:text-purple-600 transition-colors" title="Logs"><Icon name="file-text" size={15} /></button>
                                                        <button onClick={() => setShowEditService(svc)} className="p-1.5 rounded-lg hover:bg-gray-100 text-gray-400 hover:text-gray-700 transition-colors" title="Modifier"><Icon name="pencil" size={15} /></button>
                                                        <button onClick={() => setDeleteServiceTarget(svc.name)} className="p-1.5 rounded-lg hover:bg-red-50 text-gray-400 hover:text-red-600 transition-colors" title="Supprimer"><Icon name="trash-2" size={15} /></button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}

                    {/* Tab: Informations */}
                    {activeTab === 'info' && (
                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-white border border-gray-200 rounded-2xl p-5 shadow-sm">
                                <h3 className="font-semibold text-gray-900 mb-4 flex items-center gap-2"><Icon name="folder" size={16} className="text-primary-600" /> Projet</h3>
                                <div className="space-y-3">
                                    {[
                                        { label: 'Nom', value: project.config?.name || projectName },
                                        { label: 'Chemin', value: `/var/www/${projectName}` },
                                        { label: 'Sites', value: `/var/www/${projectName}/sites` },
                                        { label: 'Créé le', value: project.config?.createdAt ? new Date(project.config.createdAt).toLocaleString('fr-FR') : '—' },
                                    ].map(({ label, value }) => (
                                        <div key={label} className="flex justify-between items-start gap-4 py-2 border-b border-gray-50 last:border-0">
                                            <span className="text-xs font-medium text-gray-500 uppercase tracking-wide shrink-0">{label}</span>
                                            <code className="text-xs text-gray-800 bg-gray-50 px-2 py-1 rounded text-right break-all">{value}</code>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div className="bg-white border border-gray-200 rounded-2xl p-5 shadow-sm">
                                <h3 className="font-semibold text-gray-900 mb-4 flex items-center gap-2"><Icon name="user" size={16} className="text-primary-600" /> SFTP</h3>
                                <div className="space-y-3">
                                    {[
                                        { label: 'Utilisateur', value: project.sftpUser || project.config?.sftpUser || '—' },
                                        { label: 'Chroot', value: `/var/www/${projectName}` },
                                        { label: 'Accès', value: `/var/www/${projectName}/sites` },
                                    ].map(({ label, value }) => (
                                        <div key={label} className="flex justify-between items-start gap-4 py-2 border-b border-gray-50 last:border-0">
                                            <span className="text-xs font-medium text-gray-500 uppercase tracking-wide shrink-0">{label}</span>
                                            <code className="text-xs text-gray-800 bg-gray-50 px-2 py-1 rounded text-right break-all">{value}</code>
                                        </div>
                                    ))}
                                </div>
                                <button onClick={() => setShowChangePassword(true)} className="mt-4 w-full flex items-center justify-center gap-2 px-3 py-2 rounded-lg bg-gray-50 hover:bg-gray-100 text-gray-700 border border-gray-200 text-sm transition-colors">
                                    <Icon name="key" size={14} /> Changer le mot de passe SFTP
                                </button>
                            </div>
                            {projectDatabase && (
                                <div className="bg-white border border-gray-200 rounded-2xl p-5 shadow-sm col-span-2">
                                    <h3 className="font-semibold text-gray-900 mb-4 flex items-center gap-2"><Icon name="database" size={16} className="text-emerald-600" /> Base de données liée</h3>
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-3">
                                            <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${projectDatabase.type === 'mysql' ? 'bg-blue-50' : 'bg-green-50'}`}>
                                                <Icon name="database" size={18} className={projectDatabase.type === 'mysql' ? 'text-blue-600' : 'text-green-600'} />
                                            </div>
                                            <div>
                                                <p className="font-medium text-gray-900">{projectDatabase.name}</p>
                                                <p className="text-xs text-gray-500">{projectDatabase.type.toUpperCase()} — {projectDatabase.host}:{projectDatabase.port}</p>
                                            </div>
                                        </div>
                                        <button onClick={() => onNavigate('database-editor', projectDatabase.id)} className="flex items-center gap-2 px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-medium transition-colors">
                                            <Icon name="terminal" size={14} /> Ouvrir l'éditeur
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Tab: Scripts */}
                    {activeTab === 'scripts' && (
                        <div className="bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden">
                            <div className="px-6 py-4 border-b border-gray-100">
                                <h2 className="font-semibold text-gray-900 flex items-center gap-2">
                                    <Icon name="terminal" size={17} className="text-primary-600" /> Chemins des scripts
                                </h2>
                            </div>
                            {project.scripts ? (
                                <div className="p-4 grid grid-cols-1 gap-2">
                                    {Object.entries(project.scripts).map(([key, val]) => (
                                        <div key={key} className="flex items-center gap-3 bg-gray-50 border border-gray-100 rounded-xl px-4 py-3">
                                            <span className="text-xs font-bold text-gray-500 uppercase tracking-wider w-16 shrink-0">{key}</span>
                                            <code className="text-sm text-primary-700 font-mono flex-1 truncate">{val}</code>
                                            <button onClick={() => { navigator.clipboard.writeText(val); }} className="p-1.5 rounded-lg hover:bg-white text-gray-400 hover:text-gray-600 transition-colors shrink-0" title="Copier">
                                                <Icon name="copy" size={13} />
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="px-6 py-12 text-center text-gray-500">Aucun script disponible</div>
                            )}
                        </div>
                    )}

                    {/* Modals */}
                    {showAddService && <AddServiceModal projectName={projectName} onClose={() => setShowAddService(false)} onSuccess={() => { setShowAddService(false); loadProject(); }} showToast={showToast} />}
                    {showEditService && <EditServiceModal projectName={projectName} service={showEditService} onClose={() => setShowEditService(null)} onSuccess={() => { setShowEditService(null); loadProject(); }} showToast={showToast} />}
                    {showLogs && <LogsModal projectName={projectName} serviceName={showLogs} onClose={() => setShowLogs(null)} showToast={showToast} />}
                    {showChangePassword && <ChangePasswordModal projectName={projectName} onClose={() => setShowChangePassword(false)} showToast={showToast} />}
                    {deleteServiceTarget && (
                        <ConfirmDialog
                            title="Supprimer le service"
                            message={`Supprimer le service "${deleteServiceTarget}" ? Il sera arrêté et retiré de PM2.`}
                            onConfirm={handleDeleteService}
                            onCancel={() => setDeleteServiceTarget(null)}
                            danger
                        />
                    )}
                </div>
            );
        }

        // ============================================
        // Add Service Modal
        // ============================================
        function AddServiceModal({ projectName, onClose, onSuccess, showToast }) {
            const [form, setForm] = useState({ name: '', directory: '', command: 'npm start', description: '', setupCommands: '' });
            const [loading, setLoading] = useState(false);

            async function handleSubmit(e) {
                e.preventDefault();
                setLoading(true);
                const result = await api.post(`/api/projects/${projectName}/services`, {
                    ...form,
                    directory: form.directory || form.name,
                    setupCommands: form.setupCommands ? form.setupCommands.split(';').map(c => c.trim()).filter(c => c) : []
                });
                setLoading(false);
                if (result.success) {
                    showToast(`Service "${form.name}" ajouté`, 'success');
                    onSuccess();
                } else {
                    showToast(result.error, 'error');
                }
            }

            return (
                <Modal title="Ajouter un service" onClose={onClose}>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1.5 flex items-center gap-2">
                                <Icon name="package" size={14} /> Nom du service
                            </label>
                            <input type="text" value={form.name} onChange={e => setForm({...form, name: e.target.value})} placeholder="api, site, admin..." required
                                className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 placeholder-gray-400 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 text-sm" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1.5 flex items-center gap-2">
                                <Icon name="folder-open" size={14} /> Dossier (relatif à sites/ ou absolu)
                            </label>
                            <input type="text" value={form.directory} onChange={e => setForm({...form, directory: e.target.value})} placeholder={form.name || 'nom-du-service'}
                                className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 placeholder-gray-400 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 text-sm" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1.5 flex items-center gap-2">
                                <Icon name="settings" size={14} /> Commandes de setup (séparées par ;)
                            </label>
                            <input type="text" value={form.setupCommands} onChange={e => setForm({...form, setupCommands: e.target.value})} placeholder="npm install; npm run build"
                                className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 placeholder-gray-400 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 text-sm" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1.5 flex items-center gap-2">
                                <Icon name="play-circle" size={14} /> Commande de démarrage (PM2)
                            </label>
                            <input type="text" value={form.command} onChange={e => setForm({...form, command: e.target.value})} required
                                className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 placeholder-gray-400 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 text-sm" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1.5 flex items-center gap-2">
                                <Icon name="file-text" size={14} /> Description (optionnel)
                            </label>
                            <input type="text" value={form.description} onChange={e => setForm({...form, description: e.target.value})} placeholder="API principale..."
                                className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 placeholder-gray-400 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 text-sm" />
                        </div>
                        <div className="flex justify-end gap-3 pt-2">
                            <button type="button" onClick={onClose} className="px-4 py-2 rounded-lg bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 text-sm transition-colors">Annuler</button>
                            <button type="submit" disabled={loading} className="px-4 py-2 rounded-lg bg-primary-600 hover:bg-primary-700 text-white text-sm font-medium transition-colors disabled:opacity-50">
                                {loading ? 'Ajout...' : 'Ajouter'}
                            </button>
                        </div>
                    </form>
                </Modal>
            );
        }

        // ============================================
        // Edit Service Modal
        // ============================================
        function EditServiceModal({ projectName, service, onClose, onSuccess, showToast }) {
            const [form, setForm] = useState({
                directory: service.directory || '',
                command: service.command || 'npm start',
                description: service.description || '',
                setupCommands: (service.setupCommands || []).join('; ')
            });
            const [loading, setLoading] = useState(false);

            async function handleSubmit(e) {
                e.preventDefault();
                setLoading(true);
                const result = await api.put(`/api/projects/${projectName}/services/${service.name}`, {
                    ...form,
                    setupCommands: form.setupCommands ? form.setupCommands.split(';').map(c => c.trim()).filter(c => c) : []
                });
                setLoading(false);
                if (result.success) {
                    showToast(`Service "${service.name}" mis à jour`, 'success');
                    onSuccess();
                } else {
                    showToast(result.error, 'error');
                }
            }

            return (
                <Modal title={`Modifier: ${service.name}`} onClose={onClose}>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1.5 flex items-center gap-2">
                                <Icon name="folder-open" size={14} /> Dossier
                            </label>
                            <input type="text" value={form.directory} onChange={e => setForm({...form, directory: e.target.value})}
                                className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 text-sm" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1.5 flex items-center gap-2">
                                <Icon name="settings" size={14} /> Commandes de setup (séparées par ;)
                            </label>
                            <input type="text" value={form.setupCommands} onChange={e => setForm({...form, setupCommands: e.target.value})}
                                className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 text-sm" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1.5 flex items-center gap-2">
                                <Icon name="play-circle" size={14} /> Commande de démarrage
                            </label>
                            <input type="text" value={form.command} onChange={e => setForm({...form, command: e.target.value})} required
                                className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 text-sm" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1.5 flex items-center gap-2">
                                <Icon name="file-text" size={14} /> Description
                            </label>
                            <input type="text" value={form.description} onChange={e => setForm({...form, description: e.target.value})}
                                className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 text-sm" />
                        </div>
                        <div className="flex justify-end gap-3 pt-2">
                            <button type="button" onClick={onClose} className="px-4 py-2 rounded-lg bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 text-sm transition-colors">Annuler</button>
                            <button type="submit" disabled={loading} className="px-4 py-2 rounded-lg bg-primary-600 hover:bg-primary-700 text-white text-sm font-medium transition-colors disabled:opacity-50">
                                {loading ? 'Mise à jour...' : 'Enregistrer'}
                            </button>
                        </div>
                    </form>
                </Modal>
            );
        }

        // ============================================
        // Logs Modal
        // ============================================
        function LogsModal({ projectName, serviceName, onClose, showToast }) {
            const [logs, setLogs] = useState('Chargement...');
            const [autoRefresh, setAutoRefresh] = useState(false);
            const [resetting, setResetting] = useState(false);

            const loadLogs = useCallback(async () => {
                const result = await api.get(`/api/projects/${projectName}/services/${serviceName}/logs?lines=200`);
                setLogs(result.success ? (result.data || 'Aucun log disponible') : result.error);
            }, [projectName, serviceName]);

            useEffect(() => { loadLogs(); }, [loadLogs]);

            useEffect(() => {
                if (!autoRefresh) return;
                const interval = setInterval(loadLogs, 3000);
                return () => clearInterval(interval);
            }, [autoRefresh, loadLogs]);

            async function handleResetLogs() {
                if (!confirm('Êtes-vous sûr de vouloir réinitialiser les logs de ce service ?')) return;
                
                setResetting(true);
                const result = await api.post(`/api/projects/${projectName}/services/${serviceName}/reset-logs`);
                setResetting(false);
                
                if (result.success) {
                    showToast('Logs réinitialisés', 'success');
                    loadLogs();
                } else {
                    showToast(result.error, 'error');
                }
            }

            return (
                <Modal title={`Logs: ${projectName}-${serviceName}`} onClose={onClose} wide>
                    <div className="flex items-center justify-between mb-3">
                        <div className="flex items-center gap-2">
                            <button onClick={loadLogs} className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 text-xs transition-colors">
                                <Icon name="refresh-cw" size={13} /> Rafraîchir
                            </button>
                            <label className="flex items-center gap-2 text-xs text-gray-600 cursor-pointer">
                                <input type="checkbox" checked={autoRefresh} onChange={e => setAutoRefresh(e.target.checked)} className="rounded" />
                                Auto-refresh (3s)
                            </label>
                        </div>
                        <button 
                            onClick={handleResetLogs} 
                            disabled={resetting}
                            className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-red-50 hover:bg-red-100 text-red-700 text-xs transition-colors disabled:opacity-50"
                        >
                            <Icon name="trash-2" size={13} /> {resetting ? 'Reset...' : 'Reset logs'}
                        </button>
                    </div>
                    <pre className="log-viewer bg-gray-50 border border-gray-200 rounded-lg p-4 max-h-96 overflow-auto text-gray-700 whitespace-pre-wrap">{logs}</pre>
                </Modal>
            );
        }

        // ============================================
        // Change Password Modal
        // ============================================
        function ChangePasswordModal({ projectName, onClose, showToast }) {
            const [form, setForm] = useState({ password: '', confirmPassword: '' });
            const [loading, setLoading] = useState(false);

            async function handleSubmit(e) {
                e.preventDefault();
                if (form.password !== form.confirmPassword) {
                    showToast('Les mots de passe ne correspondent pas', 'error');
                    return;
                }
                setLoading(true);
                const result = await api.post(`/api/projects/${projectName}/sftp/change-password`, { password: form.password });
                setLoading(false);
                if (result.success) {
                    showToast('Mot de passe SFTP changé', 'success');
                    onClose();
                } else {
                    showToast(result.error, 'error');
                }
            }

            return (
                <Modal title="Changer le mot de passe SFTP" onClose={onClose}>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1.5 flex items-center gap-2">
                                <Icon name="key" size={14} /> Nouveau mot de passe
                            </label>
                            <input type="password" value={form.password} onChange={e => setForm({...form, password: e.target.value})} minLength={8} required
                                className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 text-sm" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1.5 flex items-center gap-2">
                                <Icon name="shield-check" size={14} /> Confirmer
                            </label>
                            <input type="password" value={form.confirmPassword} onChange={e => setForm({...form, confirmPassword: e.target.value})} minLength={8} required
                                className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 text-sm" />
                        </div>
                        <div className="flex justify-end gap-3 pt-2">
                            <button type="button" onClick={onClose} className="px-4 py-2 rounded-lg bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 text-sm transition-colors">Annuler</button>
                            <button type="submit" disabled={loading} className="px-4 py-2 rounded-lg bg-primary-600 hover:bg-primary-700 text-white text-sm font-medium transition-colors disabled:opacity-50">
                                {loading ? 'Changement...' : 'Changer'}
                            </button>
                        </div>
                    </form>
                </Modal>
            );
        }

        // ============================================
        // Users Management Page (Admin only)
        // ============================================
        function UsersManagementPage({ showToast, onNavigate, allProjects }) {
            const [users, setUsers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showCreateUser, setShowCreateUser] = useState(false);
            const [showAssignProjects, setShowAssignProjects] = useState(null);
            const [editTarget, setEditTarget] = useState(null);
            const [deleteTarget, setDeleteTarget] = useState(null);

            const loadUsers = useCallback(async () => {
                const result = await api.get('/api/users');
                if (result.success) setUsers(result.data || []);
                setLoading(false);
            }, []);

            useEffect(() => { loadUsers(); }, [loadUsers]);

            async function handleDeleteUser() {
                if (!deleteTarget) return;
                const result = await api.del(`/api/users/${deleteTarget.id}`);
                showToast(result.success ? 'Utilisateur supprimé' : result.error, result.success ? 'success' : 'error');
                setDeleteTarget(null);
                loadUsers();
            }

            async function handleToggleRole(userId, currentRole) {
                const newRole = currentRole === 'admin' ? 'user' : 'admin';
                const result = await api.put(`/api/users/${userId}/role`, { role: newRole });
                showToast(result.success ? 'Rôle modifié' : result.error, result.success ? 'success' : 'error');
                loadUsers();
            }

            return (
                <div className="fade-in">
                    <div className="flex items-center justify-between mb-8">
                        <div>
                            <h1 className="text-2xl font-bold text-gray-900">Gestion des utilisateurs</h1>
                            <p className="text-gray-600 mt-1">{users.length} utilisateur(s) enregistré(s)</p>
                        </div>
                        <button onClick={() => setShowCreateUser(true)} className="flex items-center gap-2 px-4 py-2 rounded-lg bg-primary-600 hover:bg-primary-700 text-white transition-colors text-sm font-medium">
                            <Icon name="user-plus" size={15} />
                            Nouvel utilisateur
                        </button>
                    </div>

                    {loading ? (
                        <div className="flex items-center justify-center h-64"><Icon name="loader-2" size={32} className="animate-spin text-gray-400" /></div>
                    ) : (
                        <div className="grid gap-4">
                            {users.map(user => (
                                <div key={user.id} className="bg-white border border-gray-200 rounded-xl p-5 shadow-sm">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-4">
                                            <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${user.role === 'admin' ? 'bg-primary-50' : 'bg-emerald-50'}`}>
                                                <Icon name={user.role === 'admin' ? 'shield-check' : 'user'} size={22} className={user.role === 'admin' ? 'text-primary-600' : 'text-emerald-600'} />
                                            </div>
                                            <div>
                                                <h3 className="font-semibold text-gray-900 text-lg">
                                                    {(user.firstName || user.lastName) ? `${user.firstName} ${user.lastName}`.trim() : user.username}
                                                </h3>
                                                {(user.firstName || user.lastName) && (
                                                    <p className="text-xs text-gray-500 flex items-center gap-1 mt-0.5">
                                                        <Icon name="at-sign" size={11} /> {user.username}
                                                    </p>
                                                )}
                                                <div className="flex items-center gap-4 mt-1">
                                                    <span className={`text-xs px-2 py-0.5 rounded-full ${user.role === 'admin' ? 'bg-primary-50 text-primary-700 border border-primary-200' : 'bg-emerald-50 text-emerald-700 border border-emerald-200'}`}>
                                                        {user.role === 'admin' ? 'Administrateur' : 'Utilisateur'}
                                                    </span>
                                                    <span className="text-xs text-gray-500 flex items-center gap-1">
                                                        <Icon name="folder" size={12} /> {user.projects?.length || 0} projet(s)
                                                    </span>
                                                    <span className="text-xs text-gray-500 flex items-center gap-1">
                                                        <Icon name="calendar" size={12} /> {new Date(user.createdAt).toLocaleDateString('fr-FR')}
                                                    </span>
                                                    {user.mustChangePassword && (
                                                        <span className="text-xs px-2 py-0.5 rounded-full bg-amber-50 text-amber-700 border border-amber-200 flex items-center gap-1">
                                                            <Icon name="key" size={10} /> Doit changer mdp
                                                        </span>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <button
                                                onClick={() => setEditTarget(user)}
                                                className="px-3 py-2 rounded-lg bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 text-sm transition-colors"
                                                title="Modifier l'utilisateur"
                                            >
                                                <Icon name="pencil" size={16} />
                                            </button>
                                            <button
                                                onClick={() => setShowAssignProjects(user)}
                                                className="px-3 py-2 rounded-lg bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 text-sm transition-colors"
                                                title="Gérer les projets"
                                            >
                                                <Icon name="folder-cog" size={16} />
                                            </button>
                                            <button
                                                onClick={() => handleToggleRole(user.id, user.role)}
                                                className="px-3 py-2 rounded-lg bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 text-sm transition-colors"
                                                title={user.role === 'admin' ? 'Rétrograder en utilisateur' : 'Promouvoir en admin'}
                                            >
                                                <Icon name={user.role === 'admin' ? 'user' : 'shield-check'} size={16} />
                                            </button>
                                            <button
                                                onClick={() => setDeleteTarget(user)}
                                                className="p-2 rounded-lg hover:bg-red-50 text-gray-400 hover:text-red-600 transition-colors"
                                                title="Supprimer"
                                            >
                                                <Icon name="trash-2" size={16} />
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {showCreateUser && <CreateUserModal onClose={() => setShowCreateUser(false)} onSuccess={loadUsers} showToast={showToast} />}
                    {editTarget && <EditUserModal user={editTarget} onClose={() => setEditTarget(null)} onSuccess={loadUsers} showToast={showToast} />}
                    {showAssignProjects && <AssignProjectsModal user={showAssignProjects} allProjects={allProjects} onClose={() => setShowAssignProjects(null)} onSuccess={loadUsers} showToast={showToast} />}
                    {deleteTarget && (
                        <ConfirmDialog
                            title="Supprimer l'utilisateur"
                            message={`Êtes-vous sûr de vouloir supprimer l'utilisateur "${deleteTarget.username}" ?`}
                            onConfirm={handleDeleteUser}
                            onCancel={() => setDeleteTarget(null)}
                            danger
                        />
                    )}
                </div>
            );
        }

        // Create User Modal
        function CreateUserModal({ onClose, onSuccess, showToast }) {
            const [form, setForm] = useState({ firstName: '', lastName: '', username: '', password: '', confirmPassword: '', role: 'user', mustChangePassword: false });
            const [loading, setLoading] = useState(false);

            async function handleSubmit(e) {
                e.preventDefault();
                if (form.password !== form.confirmPassword) {
                    showToast('Les mots de passe ne correspondent pas', 'error');
                    return;
                }
                setLoading(true);
                const result = await api.post('/api/users', { firstName: form.firstName, lastName: form.lastName, username: form.username, password: form.password, role: form.role, mustChangePassword: form.mustChangePassword });
                setLoading(false);
                if (result.success) {
                    showToast('Utilisateur créé', 'success');
                    onSuccess();
                    onClose();
                } else {
                    showToast(result.error, 'error');
                }
            }

            return (
                <Modal title="Créer un utilisateur" onClose={onClose}>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div className="grid grid-cols-2 gap-3">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1.5 flex items-center gap-2">
                                    <Icon name="user" size={14} /> Prénom
                                </label>
                                <input type="text" value={form.firstName} onChange={e => setForm({...form, firstName: e.target.value})}
                                    className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 text-sm" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1.5">
                                    Nom
                                </label>
                                <input type="text" value={form.lastName} onChange={e => setForm({...form, lastName: e.target.value})}
                                    className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 text-sm" />
                            </div>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1.5 flex items-center gap-2">
                                <Icon name="at-sign" size={14} /> Nom d'utilisateur (login)
                            </label>
                            <input type="text" value={form.username} onChange={e => setForm({...form, username: e.target.value})} required
                                className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 text-sm" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1.5 flex items-center gap-2">
                                <Icon name="lock" size={14} /> Mot de passe
                            </label>
                            <input type="password" value={form.password} onChange={e => setForm({...form, password: e.target.value})} minLength={6} required
                                className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 text-sm" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1.5 flex items-center gap-2">
                                <Icon name="shield-check" size={14} /> Confirmer le mot de passe
                            </label>
                            <input type="password" value={form.confirmPassword} onChange={e => setForm({...form, confirmPassword: e.target.value})} minLength={6} required
                                className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 text-sm" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1.5 flex items-center gap-2">
                                <Icon name="shield" size={14} /> Rôle
                            </label>
                            <select value={form.role} onChange={e => setForm({...form, role: e.target.value})}
                                className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 text-sm">
                                <option value="user">Utilisateur</option>
                                <option value="admin">Administrateur</option>
                            </select>
                        </div>
                        <label className="flex items-center gap-3 cursor-pointer select-none p-3 rounded-xl border border-amber-200 bg-amber-50 hover:bg-amber-100 transition-colors">
                            <input
                                type="checkbox"
                                checked={form.mustChangePassword}
                                onChange={e => setForm({...form, mustChangePassword: e.target.checked})}
                                className="w-4 h-4 rounded accent-amber-500"
                            />
                            <div>
                                <span className="text-sm font-medium text-amber-800 flex items-center gap-1.5">
                                    <Icon name="key" size={13} className="text-amber-600" />
                                    Forcer le changement de mot de passe
                                </span>
                                <p className="text-xs text-amber-600 mt-0.5">L'utilisateur devra changer son mot de passe à la première connexion</p>
                            </div>
                        </label>
                        <div className="flex justify-end gap-3 pt-2">
                            <button type="button" onClick={onClose} className="px-4 py-2 rounded-lg bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 text-sm transition-colors">Annuler</button>
                            <button type="submit" disabled={loading} className="px-4 py-2 rounded-lg bg-primary-600 hover:bg-primary-700 text-white text-sm font-medium transition-colors disabled:opacity-50">
                                {loading ? 'Création...' : 'Créer'}
                            </button>
                        </div>
                    </form>
                </Modal>
            );
        }

        // Edit User Modal
        function EditUserModal({ user, onClose, onSuccess, showToast }) {
            const [form, setForm] = useState({
                firstName: user.firstName || '',
                lastName: user.lastName || '',
                username: user.username || '',
                newPassword: '',
                confirmPassword: '',
                mustChangePassword: user.mustChangePassword || false
            });
            const [loading, setLoading] = useState(false);

            async function handleSubmit(e) {
                e.preventDefault();
                
                // Vérifier les mots de passe si un nouveau est fourni
                if (form.newPassword && form.newPassword !== form.confirmPassword) {
                    showToast('Les mots de passe ne correspondent pas', 'error');
                    return;
                }
                if (form.newPassword && form.newPassword.length < 6) {
                    showToast('Le mot de passe doit contenir au moins 6 caractères', 'error');
                    return;
                }

                setLoading(true);
                
                // Mettre à jour les informations de base
                const updateResult = await api.put(`/api/users/${user.id}`, {
                    firstName: form.firstName,
                    lastName: form.lastName,
                    username: form.username,
                    mustChangePassword: form.mustChangePassword
                });

                if (!updateResult.success) {
                    setLoading(false);
                    showToast(updateResult.error, 'error');
                    return;
                }

                // Changer le mot de passe si fourni
                if (form.newPassword) {
                    const pwResult = await api.put(`/api/users/${user.id}/password`, { password: form.newPassword });
                    if (!pwResult.success) {
                        setLoading(false);
                        showToast(pwResult.error, 'error');
                        return;
                    }
                }

                setLoading(false);
                showToast('Utilisateur modifié', 'success');
                onSuccess();
                onClose();
            }

            return (
                <Modal title={`Modifier ${user.username}`} onClose={onClose}>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div className="grid grid-cols-2 gap-3">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1.5 flex items-center gap-2">
                                    <Icon name="user" size={14} /> Prénom
                                </label>
                                <input type="text" value={form.firstName} onChange={e => setForm({...form, firstName: e.target.value})}
                                    className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 text-sm" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1.5">
                                    Nom
                                </label>
                                <input type="text" value={form.lastName} onChange={e => setForm({...form, lastName: e.target.value})}
                                    className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 text-sm" />
                            </div>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1.5 flex items-center gap-2">
                                <Icon name="at-sign" size={14} /> Nom d'utilisateur (login)
                            </label>
                            <input type="text" value={form.username} onChange={e => setForm({...form, username: e.target.value})} required
                                className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 text-sm" />
                        </div>
                        <div className="border-t border-gray-200 pt-4">
                            <p className="text-sm text-gray-500 mb-3 flex items-center gap-2">
                                <Icon name="lock" size={14} /> Changer le mot de passe (laisser vide pour ne pas modifier)
                            </p>
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1.5">
                                        Nouveau mot de passe
                                    </label>
                                    <input type="password" value={form.newPassword} onChange={e => setForm({...form, newPassword: e.target.value})}
                                        className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 text-sm" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1.5">
                                        Confirmer
                                    </label>
                                    <input type="password" value={form.confirmPassword} onChange={e => setForm({...form, confirmPassword: e.target.value})}
                                        className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 text-sm" />
                                </div>
                            </div>
                        </div>
                        <label className="flex items-center gap-3 cursor-pointer select-none p-3 rounded-xl border border-amber-200 bg-amber-50 hover:bg-amber-100 transition-colors">
                            <input
                                type="checkbox"
                                checked={form.mustChangePassword}
                                onChange={e => setForm({...form, mustChangePassword: e.target.checked})}
                                className="w-4 h-4 rounded accent-amber-500"
                            />
                            <div>
                                <span className="text-sm font-medium text-amber-800 flex items-center gap-1.5">
                                    <Icon name="key" size={13} className="text-amber-600" />
                                    Forcer le changement de mot de passe
                                </span>
                                <p className="text-xs text-amber-600 mt-0.5">L'utilisateur devra changer son mot de passe à la prochaine connexion</p>
                            </div>
                        </label>
                        <div className="flex justify-end gap-3 pt-2">
                            <button type="button" onClick={onClose} className="px-4 py-2 rounded-lg bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 text-sm transition-colors">Annuler</button>
                            <button type="submit" disabled={loading} className="px-4 py-2 rounded-lg bg-primary-600 hover:bg-primary-700 text-white text-sm font-medium transition-colors disabled:opacity-50">
                                {loading ? 'Enregistrement...' : 'Enregistrer'}
                            </button>
                        </div>
                    </form>
                </Modal>
            );
        }

        // Assign Projects Modal
        function AssignProjectsModal({ user, allProjects, onClose, onSuccess, showToast }) {
            const [selectedProjects, setSelectedProjects] = useState(user.projects || []);
            const [loading, setLoading] = useState(false);

            async function handleSave() {
                setLoading(true);
                const projectsToAdd = selectedProjects.filter(p => !user.projects.includes(p));
                const projectsToRemove = user.projects.filter(p => !selectedProjects.includes(p));

                for (const project of projectsToAdd) {
                    await api.post(`/api/users/${user.id}/projects/${project}`);
                }
                for (const project of projectsToRemove) {
                    await api.del(`/api/users/${user.id}/projects/${project}`);
                }

                setLoading(false);
                showToast('Projets mis à jour', 'success');
                onSuccess();
                onClose();
            }

            function toggleProject(projectName) {
                if (selectedProjects.includes(projectName)) {
                    setSelectedProjects(selectedProjects.filter(p => p !== projectName));
                } else {
                    setSelectedProjects([...selectedProjects, projectName]);
                }
            }

            return (
                <Modal title={`Projets de ${user.username}`} onClose={onClose}>
                    <div className="space-y-4">
                        <p className="text-sm text-gray-600 flex items-center gap-2">
                            <Icon name="info" size={14} /> Sélectionnez les projets accessibles à cet utilisateur
                        </p>
                        <div className="space-y-2 max-h-96 overflow-y-auto">
                            {allProjects.map(project => (
                                <label key={project.name} className="flex items-center gap-3 p-3 rounded-lg bg-gray-50 hover:bg-gray-100 cursor-pointer transition-colors">
                                    <input
                                        type="checkbox"
                                        checked={selectedProjects.includes(project.name)}
                                        onChange={() => toggleProject(project.name)}
                                        className="w-4 h-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500"
                                    />
                                    <div className="flex items-center gap-2 flex-1">
                                        <Icon name="folder" size={16} className="text-primary-600" />
                                        <span className="text-sm text-gray-900">{project.name}</span>
                                    </div>
                                </label>
                            ))}
                        </div>
                        <div className="flex justify-end gap-3 pt-2">
                            <button onClick={onClose} className="px-4 py-2 rounded-lg bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 text-sm transition-colors">Annuler</button>
                            <button onClick={handleSave} disabled={loading} className="px-4 py-2 rounded-lg bg-primary-600 hover:bg-primary-700 text-white text-sm font-medium transition-colors disabled:opacity-50">
                                {loading ? 'Enregistrement...' : 'Enregistrer'}
                            </button>
                        </div>
                    </div>
                </Modal>
            );
        }

        // ============================================
        // SFTP Browser Page
        // ============================================
        function SFTPBrowserPage({ projectName, onNavigate, showToast }) {
            const [files, setFiles] = useState([]);
            const [currentPath, setCurrentPath] = useState('');
            const [loading, setLoading] = useState(true);
            const [selectedItems, setSelectedItems] = useState([]);
            const [showUpload, setShowUpload] = useState(false);
            const [showNewFolder, setShowNewFolder] = useState(false);
            const [showRename, setShowRename] = useState(null);
            const [deleteTarget, setDeleteTarget] = useState(null);
            const [deleteMultiConfirm, setDeleteMultiConfirm] = useState(false);
            const [clipboard, setClipboard] = useState(null);
            const [isDragOver, setIsDragOver] = useState(false);
            const [uploadProgress, setUploadProgress] = useState(null);
            const dropZoneRef = useRef(null);

            const loadFiles = useCallback(async (path = '') => {
                setLoading(true);
                const result = await api.get(`/api/projects/${projectName}/files?path=${encodeURIComponent(path)}`);
                if (result.success) {
                    setFiles(result.data || []);
                    setCurrentPath(result.currentPath || '');
                }
                setLoading(false);
            }, [projectName]);

            useEffect(() => { loadFiles(currentPath); }, [loadFiles, currentPath]);

            function navigateToPath(path) {
                setCurrentPath(path);
                setSelectedItems([]);
            }

            function goUp() {
                const parts = currentPath.split('/').filter(p => p);
                parts.pop();
                navigateToPath(parts.join('/'));
            }

            function toggleSelect(file, e) {
                e.stopPropagation();
                const path = file.path;
                setSelectedItems(prev => prev.includes(path) ? prev.filter(p => p !== path) : [...prev, path]);
            }

            function toggleSelectAll() {
                setSelectedItems(selectedItems.length === files.length && files.length > 0 ? [] : files.map(f => f.path));
            }

            async function handleDelete() {
                if (!deleteTarget) return;
                const result = await api.del(`/api/projects/${projectName}/files?path=${encodeURIComponent(deleteTarget.path)}`);
                showToast(result.success ? `${deleteTarget.name} supprimé` : result.error, result.success ? 'success' : 'error');
                setDeleteTarget(null);
                loadFiles(currentPath);
            }

            async function handleDeleteSelected() {
                let errors = 0;
                for (const itemPath of selectedItems) {
                    const result = await api.del(`/api/projects/${projectName}/files?path=${encodeURIComponent(itemPath)}`);
                    if (!result.success) errors++;
                }
                showToast(errors === 0 ? `${selectedItems.length} élément(s) supprimé(s)` : `${selectedItems.length - errors} supprimé(s), ${errors} erreur(s)`, errors === 0 ? 'success' : 'error');
                setSelectedItems([]);
                setDeleteMultiConfirm(false);
                loadFiles(currentPath);
            }

            function handleCopySelected() {
                setClipboard({ items: [...selectedItems] });
                showToast(`${selectedItems.length} élément(s) copié(s)`, 'info');
            }

            async function handlePaste() {
                if (!clipboard) return;
                let errors = 0;
                for (const itemPath of clipboard.items) {
                    const name = itemPath.split('/').pop();
                    const destPath = currentPath ? `${currentPath}/${name}` : name;
                    const result = await api.post(`/api/projects/${projectName}/files/copy`, { sourcePath: itemPath, destPath });
                    if (!result.success) errors++;
                }
                showToast(errors === 0 ? `${clipboard.items.length} élément(s) collé(s)` : `Erreur lors du collage`, errors === 0 ? 'success' : 'error');
                loadFiles(currentPath);
            }

            function handleDownload(file) {
                window.open(`/api/projects/${projectName}/files/download?path=${encodeURIComponent(file.path)}`, '_blank');
            }

            async function uploadEntriesWithProgress(allEntries) {
                if (allEntries.length === 0) return;
                let done = 0;
                const total = allEntries.length;
                setUploadProgress({ current: 0, total, percent: 0, filename: '' });
                for (const { file, relativePath } of allEntries) {
                    setUploadProgress({ current: done, total, percent: Math.round((done / total) * 100), filename: relativePath });
                    const formData = new FormData();
                    formData.append('path', currentPath);
                    formData.append('files', file);
                    formData.append('relativePath_0', relativePath);
                    try { await fetch(`/api/projects/${projectName}/files/upload`, { method: 'POST', body: formData }); } catch {}
                    done++;
                }
                setUploadProgress(null);
                showToast(`${done} fichier(s) uploadé(s)`, 'success');
                loadFiles(currentPath);
            }

            async function collectEntry(entry, prefix) {
                if (entry.isFile) {
                    return new Promise(resolve => entry.file(f => resolve([{ file: f, relativePath: prefix ? `${prefix}/${f.name}` : f.name }])));
                }
                if (entry.isDirectory) {
                    const reader = entry.createReader();
                    const dirPrefix = prefix ? `${prefix}/${entry.name}` : entry.name;
                    return new Promise(resolve => {
                        const results = [];
                        function readBatch() {
                            reader.readEntries(async entries => {
                                if (entries.length === 0) { resolve(results); return; }
                                for (const e of entries) { results.push(...(await collectEntry(e, dirPrefix))); }
                                readBatch();
                            });
                        }
                        readBatch();
                    });
                }
                return [];
            }

            async function onDrop(e) {
                e.preventDefault();
                e.stopPropagation();
                setIsDragOver(false);
                const items = Array.from(e.dataTransfer.items);
                const allEntries = [];
                for (const item of items) {
                    const entry = item.webkitGetAsEntry ? item.webkitGetAsEntry() : null;
                    if (entry) { allEntries.push(...(await collectEntry(entry, ''))); }
                    else if (item.getAsFile) { const f = item.getAsFile(); if (f) allEntries.push({ file: f, relativePath: f.name }); }
                }
                await uploadEntriesWithProgress(allEntries);
            }

            function onDragOver(e) { e.preventDefault(); e.stopPropagation(); setIsDragOver(true); }
            function onDragLeave(e) { if (!dropZoneRef.current?.contains(e.relatedTarget)) setIsDragOver(false); }

            const pathParts = currentPath ? currentPath.split('/').filter(p => p) : [];
            const allSelected = files.length > 0 && selectedItems.length === files.length;
            const someSelected = selectedItems.length > 0;

            return (
                <div className="fade-in">
                    <button onClick={() => onNavigate('project-detail', projectName)} className="flex items-center gap-1 text-gray-600 hover:text-gray-900 text-sm mb-6 transition-colors">
                        <Icon name="arrow-left" size={16} /> Retour au projet
                    </button>

                    <div className="flex items-center justify-between mb-8">
                        <div>
                            <h1 className="text-2xl font-bold text-gray-900">Gestionnaire de fichiers SFTP</h1>
                            <p className="text-gray-600 mt-1">Projet : {projectName}</p>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setShowNewFolder(true)} className="flex items-center gap-2 px-4 py-2 rounded-lg bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 transition-colors text-sm">
                                <Icon name="folder-plus" size={15} /> Nouveau dossier
                            </button>
                            <button onClick={() => setShowUpload(true)} className="flex items-center gap-2 px-4 py-2 rounded-lg bg-primary-600 hover:bg-primary-700 text-white transition-colors text-sm font-medium">
                                <Icon name="upload" size={15} /> Upload
                            </button>
                        </div>
                    </div>

                    {/* Breadcrumb + barre d'actions */}
                    <div className="bg-white border border-gray-200 rounded-lg px-4 py-2.5 mb-4 flex items-center gap-2 text-sm flex-wrap">
                        <Icon name="folder" size={16} className="text-primary-600 shrink-0" />
                        <button onClick={() => navigateToPath('')} className="text-primary-600 hover:text-primary-700 transition-colors font-medium">sites</button>
                        {pathParts.map((part, i) => (
                            <React.Fragment key={i}>
                                <span className="text-gray-400">/</span>
                                <button onClick={() => navigateToPath(pathParts.slice(0, i + 1).join('/'))} className="text-primary-600 hover:text-primary-700 transition-colors font-medium">{part}</button>
                            </React.Fragment>
                        ))}
                        <div className="ml-auto flex items-center gap-1.5 shrink-0">
                            {someSelected && (
                                <>
                                    <span className="text-xs text-gray-400 mr-1">{selectedItems.length} sél.</span>
                                    <button onClick={handleCopySelected} className="flex items-center gap-1 px-2.5 py-1.5 rounded-lg bg-blue-50 hover:bg-blue-100 text-blue-700 text-xs font-medium transition-colors">
                                        <Icon name="copy" size={12} /> Copier
                                    </button>
                                    <button onClick={() => setDeleteMultiConfirm(true)} className="flex items-center gap-1 px-2.5 py-1.5 rounded-lg bg-red-50 hover:bg-red-100 text-red-700 text-xs font-medium transition-colors">
                                        <Icon name="trash-2" size={12} /> Supprimer
                                    </button>
                                </>
                            )}
                            {clipboard && (
                                <button onClick={handlePaste} className="flex items-center gap-1 px-2.5 py-1.5 rounded-lg bg-emerald-50 hover:bg-emerald-100 text-emerald-700 text-xs font-medium transition-colors">
                                    <Icon name="clipboard" size={12} /> Coller ({clipboard.items.length})
                                </button>
                            )}
                        </div>
                    </div>

                    {/* Barre de progression upload */}
                    {uploadProgress && (
                        <div className="bg-white border border-primary-200 rounded-lg px-4 py-3 mb-4">
                            <div className="flex items-center justify-between mb-1.5">
                                <span className="text-xs font-medium text-gray-700 flex items-center gap-1.5"><Icon name="upload-cloud" size={13} /> Upload en cours...</span>
                                <span className="text-xs text-gray-500">{uploadProgress.current}/{uploadProgress.total} — {uploadProgress.percent}%</span>
                            </div>
                            <div className="w-full bg-gray-200 rounded-full h-1.5 mb-1">
                                <div className="bg-primary-600 h-1.5 rounded-full transition-all duration-200" style={{ width: `${uploadProgress.percent}%` }}></div>
                            </div>
                            <p className="text-xs text-gray-400 truncate">{uploadProgress.filename}</p>
                        </div>
                    )}

                    {loading ? (
                        <div className="flex items-center justify-center h-64"><Icon name="loader-2" size={32} className="animate-spin text-gray-400" /></div>
                    ) : (
                        <div
                            ref={dropZoneRef}
                            onDragOver={onDragOver}
                            onDragLeave={onDragLeave}
                            onDrop={onDrop}
                            className={`relative bg-white rounded-xl overflow-hidden shadow-sm transition-all border-2 ${isDragOver ? 'border-primary-400 bg-primary-50/60' : 'border-gray-200'}`}
                        >
                            {isDragOver && (
                                <div className="absolute inset-0 z-10 flex flex-col items-center justify-center bg-primary-50/80 pointer-events-none">
                                    <Icon name="upload-cloud" size={52} className="text-primary-500 mb-3" />
                                    <p className="text-primary-700 font-semibold text-lg">Déposer ici pour uploader</p>
                                    <p className="text-primary-500 text-sm mt-1">Fichiers et dossiers acceptés</p>
                                </div>
                            )}
                            <table className="w-full">
                                <thead>
                                    <tr className="border-b border-gray-200 bg-gray-50">
                                        <th className="px-4 py-3 w-10">
                                            <input type="checkbox" checked={allSelected} onChange={toggleSelectAll} className="w-4 h-4 rounded border-gray-300 text-primary-600 cursor-pointer" title="Tout sélectionner" />
                                        </th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase">Nom</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase">Taille</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase">Modifié</th>
                                        <th className="px-4 py-3 text-right text-xs font-medium text-gray-600 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200">
                                    {currentPath && (
                                        <tr className="hover:bg-gray-50 transition-colors cursor-pointer" onClick={goUp}>
                                            <td className="px-4 py-3"></td>
                                            <td className="px-4 py-3 text-sm text-gray-900">
                                                <div className="flex items-center gap-2">
                                                    <Icon name="corner-up-left" size={16} className="text-gray-400" />
                                                    <span>..</span>
                                                </div>
                                            </td>
                                            <td className="px-4 py-3"></td>
                                            <td className="px-4 py-3"></td>
                                            <td className="px-4 py-3"></td>
                                        </tr>
                                    )}
                                    {files.length === 0 ? (
                                        <tr>
                                            <td colSpan="5" className="px-6 py-16 text-center text-gray-400">
                                                <Icon name="upload-cloud" size={40} className="mx-auto mb-3 text-gray-300" />
                                                <p className="font-medium">Dossier vide</p>
                                                <p className="text-xs mt-1">Glissez-déposez des fichiers ou dossiers ici</p>
                                            </td>
                                        </tr>
                                    ) : (
                                        files.map(file => (
                                            <tr key={file.path} className={`hover:bg-gray-50 transition-colors ${selectedItems.includes(file.path) ? 'bg-primary-50' : ''}`}>
                                                <td className="px-4 py-3">
                                                    <input
                                                        type="checkbox"
                                                        checked={selectedItems.includes(file.path)}
                                                        onChange={e => toggleSelect(file, e)}
                                                        className="w-4 h-4 rounded border-gray-300 text-primary-600 cursor-pointer"
                                                    />
                                                </td>
                                                <td className="px-4 py-3 text-sm text-gray-900 font-medium cursor-pointer" onClick={() => file.type === 'directory' && navigateToPath(file.path)}>
                                                    <div className="flex items-center gap-2">
                                                        <Icon name={file.type === 'directory' ? 'folder' : 'file'} size={16} className={file.type === 'directory' ? 'text-primary-500' : 'text-gray-400'} />
                                                        <span>{file.name}</span>
                                                    </div>
                                                </td>
                                                <td className="px-4 py-3 text-sm text-gray-500">
                                                    {file.type === 'file' ? `${(file.size / 1024).toFixed(1)} KB` : '—'}
                                                </td>
                                                <td className="px-4 py-3 text-sm text-gray-500">
                                                    {new Date(file.modified).toLocaleString('fr-FR')}
                                                </td>
                                                <td className="px-4 py-3">
                                                    <div className="flex items-center justify-end gap-1">
                                                        {file.type === 'file' && (
                                                            <button onClick={() => handleDownload(file)} className="p-1.5 rounded hover:bg-primary-50 text-gray-400 hover:text-primary-600 transition-colors" title="Télécharger">
                                                                <Icon name="download" size={14} />
                                                            </button>
                                                        )}
                                                        <button onClick={() => setShowRename(file)} className="p-1.5 rounded hover:bg-yellow-50 text-gray-400 hover:text-yellow-600 transition-colors" title="Renommer">
                                                            <Icon name="edit-2" size={14} />
                                                        </button>
                                                        <button onClick={() => setDeleteTarget(file)} className="p-1.5 rounded hover:bg-red-50 text-gray-400 hover:text-red-600 transition-colors" title="Supprimer">
                                                            <Icon name="trash-2" size={14} />
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                            {!isDragOver && (
                                <div className="px-4 py-2 border-t border-gray-100 bg-gray-50 text-xs text-gray-400 flex items-center gap-1.5">
                                    <Icon name="upload-cloud" size={12} /> Glissez-déposez des fichiers ou dossiers ici pour les uploader
                                </div>
                            )}
                        </div>
                    )}

                    {showUpload && <UploadFileModal projectName={projectName} currentPath={currentPath} onClose={() => setShowUpload(false)} onSuccess={() => { setShowUpload(false); loadFiles(currentPath); }} showToast={showToast} uploadEntriesWithProgress={uploadEntriesWithProgress} />}
                    {showNewFolder && <NewFolderModal projectName={projectName} currentPath={currentPath} onClose={() => setShowNewFolder(false)} onSuccess={() => { setShowNewFolder(false); loadFiles(currentPath); }} showToast={showToast} />}
                    {showRename && <RenameModal projectName={projectName} file={showRename} onClose={() => setShowRename(null)} onSuccess={() => { setShowRename(null); loadFiles(currentPath); }} showToast={showToast} />}
                    {deleteTarget && (
                        <ConfirmDialog
                            title={`Supprimer ${deleteTarget.type === 'directory' ? 'le dossier' : 'le fichier'}`}
                            message={`Êtes-vous sûr de vouloir supprimer "${deleteTarget.name}" ?`}
                            onConfirm={handleDelete}
                            onCancel={() => setDeleteTarget(null)}
                            danger
                        />
                    )}
                    {deleteMultiConfirm && (
                        <ConfirmDialog
                            title="Supprimer la sélection"
                            message={`Supprimer ${selectedItems.length} élément(s) ? Cette action est irréversible.`}
                            onConfirm={handleDeleteSelected}
                            onCancel={() => setDeleteMultiConfirm(false)}
                            danger
                        />
                    )}
                </div>
            );
        }

        // Upload File Modal
        function UploadFileModal({ projectName, currentPath, onClose, onSuccess, showToast, uploadEntriesWithProgress }) {
            const [uploadMode, setUploadMode] = useState('files');
            const [selectedFiles, setSelectedFiles] = useState([]);
            const [progress, setProgress] = useState(null);
            const fileInputRef = useRef(null);
            const folderInputRef = useRef(null);

            function handleFileSelection(e) {
                setSelectedFiles(Array.from(e.target.files));
            }

            async function handleUpload(e) {
                e.preventDefault();
                if (selectedFiles.length === 0) return;

                const entries = selectedFiles.map(file => ({
                    file,
                    relativePath: (uploadMode === 'folder' && file.webkitRelativePath) ? file.webkitRelativePath : file.name
                }));

                let done = 0;
                const total = entries.length;
                setProgress({ current: 0, total, percent: 0, filename: '' });

                for (const { file, relativePath } of entries) {
                    setProgress({ current: done, total, percent: Math.round((done / total) * 100), filename: relativePath });
                    const formData = new FormData();
                    formData.append('path', currentPath);
                    formData.append('files', file);
                    formData.append('relativePath_0', relativePath);
                    try { await fetch(`/api/projects/${projectName}/files/upload`, { method: 'POST', body: formData }); } catch {}
                    done++;
                }

                setProgress(null);
                showToast(`${done} fichier(s) uploadé(s)`, 'success');
                onSuccess();
            }

            const totalSize = selectedFiles.reduce((sum, f) => sum + f.size, 0);

            return (
                <Modal title="Upload fichiers / dossier" onClose={!progress ? onClose : undefined}>
                    <div className="space-y-4">
                        <div className="flex gap-2">
                            <button type="button" onClick={() => { setUploadMode('files'); setSelectedFiles([]); }}
                                className={`flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors border ${uploadMode === 'files' ? 'bg-primary-600 text-white border-primary-600' : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'}`}>
                                <Icon name="file" size={14} /> Fichiers
                            </button>
                            <button type="button" onClick={() => { setUploadMode('folder'); setSelectedFiles([]); }}
                                className={`flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors border ${uploadMode === 'folder' ? 'bg-primary-600 text-white border-primary-600' : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'}`}>
                                <Icon name="folder" size={14} /> Dossier
                            </button>
                        </div>

                        <div
                            onClick={() => (uploadMode === 'folder' ? folderInputRef : fileInputRef).current?.click()}
                            className="border-2 border-dashed border-gray-300 hover:border-primary-400 rounded-xl p-8 text-center cursor-pointer transition-colors"
                        >
                            <Icon name="upload-cloud" size={36} className="mx-auto mb-2 text-gray-400" />
                            <p className="text-sm text-gray-600 font-medium">
                                {uploadMode === 'folder' ? 'Cliquer pour sélectionner un dossier' : 'Cliquer pour sélectionner des fichiers'}
                            </p>
                            <p className="text-xs text-gray-400 mt-1">Ou glissez-déposez directement dans le gestionnaire</p>
                            <input ref={fileInputRef} type="file" multiple onChange={handleFileSelection} className="hidden" />
                            <input ref={folderInputRef} type="file" webkitdirectory="true" onChange={handleFileSelection} className="hidden" />
                        </div>

                        {selectedFiles.length > 0 && (
                            <div className="bg-gray-50 rounded-lg border border-gray-200 p-3">
                                <p className="text-xs font-medium text-gray-700 mb-2">
                                    {selectedFiles.length} fichier(s) — {(totalSize / 1024 / 1024).toFixed(2)} MB
                                </p>
                                <div className="max-h-28 overflow-y-auto space-y-0.5">
                                    {selectedFiles.slice(0, 12).map((file, i) => (
                                        <p key={i} className="text-xs text-gray-500 truncate">
                                            {uploadMode === 'folder' && file.webkitRelativePath ? file.webkitRelativePath : file.name}
                                        </p>
                                    ))}
                                    {selectedFiles.length > 12 && <p className="text-xs text-gray-400 italic">... et {selectedFiles.length - 12} autre(s)</p>}
                                </div>
                            </div>
                        )}

                        {progress && (
                            <div className="bg-primary-50 border border-primary-200 rounded-lg p-3">
                                <div className="flex justify-between mb-1.5">
                                    <span className="text-xs font-medium text-primary-700">Upload en cours...</span>
                                    <span className="text-xs text-primary-600">{progress.current}/{progress.total} — {progress.percent}%</span>
                                </div>
                                <div className="w-full bg-primary-200 rounded-full h-1.5 mb-1">
                                    <div className="bg-primary-600 h-1.5 rounded-full transition-all duration-200" style={{ width: `${progress.percent}%` }}></div>
                                </div>
                                <p className="text-xs text-primary-500 truncate">{progress.filename}</p>
                            </div>
                        )}

                        <div className="flex justify-end gap-3 pt-1">
                            <button type="button" onClick={onClose} disabled={!!progress} className="px-4 py-2 rounded-lg bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 text-sm transition-colors disabled:opacity-40">
                                Annuler
                            </button>
                            <button onClick={handleUpload} disabled={!!progress || selectedFiles.length === 0} className="px-4 py-2 rounded-lg bg-primary-600 hover:bg-primary-700 text-white text-sm font-medium transition-colors disabled:opacity-50">
                                {progress ? 'Upload...' : `Uploader (${selectedFiles.length})`}
                            </button>
                        </div>
                    </div>
                </Modal>
            );
        }

        // New Folder Modal
        function NewFolderModal({ projectName, currentPath, onClose, onSuccess, showToast }) {
            const [folderName, setFolderName] = useState('');
            const [loading, setLoading] = useState(false);

            async function handleCreate(e) {
                e.preventDefault();
                setLoading(true);
                const result = await api.post(`/api/projects/${projectName}/files/mkdir`, { path: currentPath, name: folderName });
                setLoading(false);
                
                if (result.success) {
                    showToast('Dossier créé', 'success');
                    onSuccess();
                } else {
                    showToast(result.error, 'error');
                }
            }

            return (
                <Modal title="Nouveau dossier" onClose={onClose}>
                    <form onSubmit={handleCreate} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-dark-300 mb-2 flex items-center gap-2">
                                <Icon name="folder-plus" size={14} /> Nom du dossier
                            </label>
                            <input
                                type="text"
                                value={folderName}
                                onChange={e => setFolderName(e.target.value)}
                                placeholder="nouveau-dossier"
                                required
                                className="w-full px-3 py-2 bg-dark-900 border border-dark-700 rounded-lg text-white focus:outline-none focus:border-blue-500 text-sm"
                            />
                        </div>
                        <div className="flex justify-end gap-3 pt-2">
                            <button type="button" onClick={onClose} className="px-4 py-2 rounded-lg bg-dark-700 hover:bg-dark-600 text-dark-300 text-sm transition-colors">
                                Annuler
                            </button>
                            <button type="submit" disabled={loading} className="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white text-sm font-medium transition-colors disabled:opacity-50">
                                {loading ? 'Création...' : 'Créer'}
                            </button>
                        </div>
                    </form>
                </Modal>
            );
        }

        // Rename Modal
        function RenameModal({ projectName, file, onClose, onSuccess, showToast }) {
            const [newName, setNewName] = useState(file.name);
            const [loading, setLoading] = useState(false);

            async function handleRename(e) {
                e.preventDefault();
                if (newName === file.name) {
                    onClose();
                    return;
                }
                
                setLoading(true);
                const result = await api.put(`/api/projects/${projectName}/files/rename`, { path: file.path, newName });
                setLoading(false);
                
                if (result.success) {
                    showToast('Renommé avec succès', 'success');
                    onSuccess();
                } else {
                    showToast(result.error, 'error');
                }
            }

            return (
                <Modal title={`Renommer: ${file.name}`} onClose={onClose}>
                    <form onSubmit={handleRename} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-dark-300 mb-2 flex items-center gap-2">
                                <Icon name="edit-2" size={14} /> Nouveau nom
                            </label>
                            <input
                                type="text"
                                value={newName}
                                onChange={e => setNewName(e.target.value)}
                                required
                                className="w-full px-3 py-2 bg-dark-900 border border-dark-700 rounded-lg text-white focus:outline-none focus:border-blue-500 text-sm"
                            />
                        </div>
                        <div className="flex justify-end gap-3 pt-2">
                            <button type="button" onClick={onClose} className="px-4 py-2 rounded-lg bg-dark-700 hover:bg-dark-600 text-dark-300 text-sm transition-colors">
                                Annuler
                            </button>
                            <button type="submit" disabled={loading} className="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white text-sm font-medium transition-colors disabled:opacity-50">
                                {loading ? 'Renommage...' : 'Renommer'}
                            </button>
                        </div>
                    </form>
                </Modal>
            );
        }

        // ============================================
        // Databases Page
        // ============================================
        function DatabasesPage({ showToast, currentUser, onNavigate }) {
            const [databases, setDatabases] = useState([]);
            const [projects, setProjects] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showCreateModal, setShowCreateModal] = useState(false);
            const [editTarget, setEditTarget] = useState(null);
            const [deleteTarget, setDeleteTarget] = useState(null);

            const isAdmin = currentUser?.role === 'admin';

            const loadDatabases = useCallback(async () => {
                const result = await api.get('/api/databases');
                if (result.success) {
                    setDatabases(result.data || []);
                }
                setLoading(false);
            }, []);

            const loadProjects = useCallback(async () => {
                const result = await api.get('/api/projects');
                if (result.success) {
                    setProjects(result.data || []);
                }
            }, []);

            useEffect(() => {
                loadDatabases();
                loadProjects();
            }, [loadDatabases, loadProjects]);

            async function handleDelete() {
                if (!deleteTarget) return;
                const result = await api.del(`/api/databases/${deleteTarget.id}`);
                showToast(result.success ? 'Base de données supprimée' : result.error, result.success ? 'success' : 'error');
                setDeleteTarget(null);
                loadDatabases();
            }

            // Filtrer les BDD selon l'utilisateur:
            // - Admin voit toutes les BDD
            // - Utilisateur normal voit uniquement les BDD associées à ses projets
            // - Les BDD sans projet (projectName null) ne sont visibles que par les admins
            const filteredDatabases = isAdmin 
                ? databases 
                : databases.filter(db => db.projectName && currentUser?.projects?.includes(db.projectName));

            const mysqlDbs = filteredDatabases.filter(db => db.type === 'mysql');
            const mongoDbs = filteredDatabases.filter(db => db.type === 'mongodb');

            return (
                <div className="fade-in">
                    <div className="flex items-center justify-between mb-8">
                        <div>
                            <h1 className="text-2xl font-bold text-gray-900">Bases de données</h1>
                            <p className="text-gray-600 mt-1">{filteredDatabases.length} base(s) de données accessible(s)</p>
                        </div>
                        {isAdmin && (
                            <button onClick={() => setShowCreateModal(true)} className="flex items-center gap-2 px-4 py-2 rounded-lg bg-primary-600 hover:bg-primary-700 text-white transition-colors text-sm font-medium">
                                <Icon name="plus" size={15} />
                                Nouvelle base de données
                            </button>
                        )}
                    </div>

                    {loading ? (
                        <div className="flex items-center justify-center h-64">
                            <Icon name="loader-2" size={32} className="animate-spin text-gray-400" />
                        </div>
                    ) : filteredDatabases.length === 0 ? (
                        <div className="bg-white border border-gray-200 rounded-xl px-6 py-16 text-center shadow-sm">
                            <Icon name="database" size={48} className="text-gray-300 mx-auto mb-4" />
                            <p className="text-gray-900 text-lg mb-2">Aucune base de données</p>
                            <p className="text-gray-600 text-sm mb-4">Commencez par créer votre première base de données</p>
                            {isAdmin && (
                                <button onClick={() => setShowCreateModal(true)} className="px-4 py-2 rounded-lg bg-primary-600 hover:bg-primary-700 text-white text-sm font-medium transition-colors">
                                    Créer une base de données
                                </button>
                            )}
                        </div>
                    ) : (
                        <div className="space-y-3">
                            {mysqlDbs.length > 0 && (
                                <div>
                                    <h2 className="text-sm font-semibold text-gray-900 mb-2 flex items-center gap-1.5">
                                        <Icon name="database" size={16} className="text-blue-600" />
                                        MySQL ({mysqlDbs.length})
                                    </h2>
                                    <div className="grid gap-2">
                                        {mysqlDbs.map(db => (
                                            <DatabaseCard 
                                                key={db.id} 
                                                database={db} 
                                                onEdit={() => setEditTarget(db)}
                                                onDelete={() => setDeleteTarget(db)}
                                                showToast={showToast}
                                                isAdmin={isAdmin}
                                                projects={projects}
                                                onRefresh={loadDatabases}
                                                onNavigate={onNavigate}
                                            />
                                        ))}
                                    </div>
                                </div>
                            )}

                            {mongoDbs.length > 0 && (
                                <div>
                                    <h2 className="text-sm font-semibold text-gray-900 mb-2 flex items-center gap-1.5">
                                        <Icon name="database" size={16} className="text-green-600" />
                                        MongoDB ({mongoDbs.length})
                                    </h2>
                                    <div className="grid gap-2">
                                        {mongoDbs.map(db => (
                                            <DatabaseCard 
                                                key={db.id} 
                                                database={db} 
                                                onEdit={() => setEditTarget(db)}
                                                onDelete={() => setDeleteTarget(db)}
                                                showToast={showToast}
                                                isAdmin={isAdmin}
                                                projects={projects}
                                                onRefresh={loadDatabases}
                                                onNavigate={onNavigate}
                                            />
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {showCreateModal && (
                        <CreateDatabaseModal 
                            onClose={() => setShowCreateModal(false)}
                            onSuccess={() => { setShowCreateModal(false); loadDatabases(); }}
                            showToast={showToast}
                            projects={projects}
                        />
                    )}

                    {editTarget && (
                        <EditDatabaseModal 
                            database={editTarget}
                            onClose={() => setEditTarget(null)}
                            onSuccess={() => { setEditTarget(null); loadDatabases(); }}
                            showToast={showToast}
                            projects={projects}
                        />
                    )}

                    {deleteTarget && (
                        <ConfirmDialog
                            title="Supprimer la base de données"
                            message={`Êtes-vous sûr de vouloir supprimer la base de données "${deleteTarget.name}" ? Cette action est irréversible.`}
                            onConfirm={handleDelete}
                            onCancel={() => setDeleteTarget(null)}
                            danger={true}
                        />
                    )}
                </div>
            );
        }

        // ============================================
        // Database Editor Page
        // ============================================
        function DatabaseEditorPage({ databaseId, onNavigate, showToast }) {
            const [database, setDatabase] = useState(null);
            const [tables, setTables] = useState([]);
            const [collections, setCollections] = useState([]);
            const [selectedTable, setSelectedTable] = useState(null);
            const [tableData, setTableData] = useState(null);
            const [tableStructure, setTableStructure] = useState([]);
            const [loading, setLoading] = useState(true);
            const [dataLoading, setDataLoading] = useState(false);
            const [queryText, setQueryText] = useState('');
            const [queryResult, setQueryResult] = useState(null);
            const [queryLoading, setQueryLoading] = useState(false);
            const [page, setPage] = useState(0);
            const [limit] = useState(50);
            const [activeView, setActiveView] = useState('fields');
            const [editingField, setEditingField] = useState(null);
            const [editValues, setEditValues] = useState({});
            const [showAddField, setShowAddField] = useState(false);
            const [newField, setNewField] = useState({ name: '', type: 'VARCHAR(255)', nullable: 'YES', defaultVal: '', extra: '' });
            const [addFieldLoading, setAddFieldLoading] = useState(false);
            const [savingField, setSavingField] = useState(false);
            const [editingDoc, setEditingDoc] = useState(null);
            const [editingDocRaw, setEditingDocRaw] = useState(null);
            const [editDocValues, setEditDocValues] = useState({});
            const [savingDoc, setSavingDoc] = useState(false);
            const [editingRow, setEditingRow] = useState(null);
            const [editRowValues, setEditRowValues] = useState({});
            const [savingRow, setSavingRow] = useState(false);
            const [confirmDelete, setConfirmDelete] = useState(null);
            const [deletingItem, setDeletingItem] = useState(false);

            const MYSQL_TYPES = ['INT','BIGINT','TINYINT','SMALLINT','FLOAT','DOUBLE','DECIMAL(10,2)','VARCHAR(50)','VARCHAR(100)','VARCHAR(255)','TEXT','LONGTEXT','CHAR(1)','DATE','DATETIME','TIMESTAMP','BOOLEAN','JSON','BLOB'];

            const loadDatabase = useCallback(async () => {
                const result = await api.get(`/api/databases/${databaseId}`);
                if (result.success) {
                    setDatabase(result.data);
                    if (result.data.type === 'mysql') {
                        const tRes = await api.get(`/api/databases/${databaseId}/tables`);
                        if (tRes.success) setTables(tRes.data);
                    } else {
                        const cRes = await api.get(`/api/databases/${databaseId}/collections`);
                        if (cRes.success) setCollections(cRes.data);
                    }
                }
                setLoading(false);
            }, [databaseId]);

            useEffect(() => { loadDatabase(); }, [loadDatabase]);

            const loadTableStructure = async (tableName) => {
                const result = await api.get(`/api/databases/${databaseId}/tables/${tableName}/structure`);
                if (result.success) setTableStructure(result.data);
            };

            const loadTableData = async (tableName, offset = 0) => {
                setDataLoading(true);
                const result = await api.get(`/api/databases/${databaseId}/tables/${tableName}/data?limit=${limit}&offset=${offset}`);
                if (result.success) { setTableData(result.data); setPage(Math.floor(offset / limit)); }
                else showToast(result.error, 'error');
                setDataLoading(false);
            };

            const loadCollectionData = async (collectionName, skip = 0) => {
                setDataLoading(true);
                const result = await api.post(`/api/databases/${databaseId}/collections/${collectionName}/query`, { operation: 'find', query: {}, options: { limit, skip } });
                if (result.success) { setTableData(result.data); setPage(Math.floor(skip / limit)); }
                else showToast(result.error, 'error');
                setDataLoading(false);
            };

            const handleSelectTable = (name) => {
                setSelectedTable(name); setTableData(null); setTableStructure([]); setQueryResult(null); setEditingField(null);
                if (database.type === 'mysql') { setActiveView('fields'); loadTableStructure(name); loadTableData(name); }
                else { setActiveView('data'); loadCollectionData(name); }
            };

            const handleExecuteQuery = async () => {
                if (!queryText.trim()) return;
                setQueryLoading(true); setQueryResult(null);
                if (database.type === 'mysql') {
                    const result = await api.post(`/api/databases/${databaseId}/query`, { query: queryText });
                    if (result.success) { setQueryResult(result.data); showToast('Requête exécutée', 'success'); } else showToast(result.error, 'error');
                } else {
                    try {
                        const parsed = JSON.parse(queryText);
                        const result = await api.post(`/api/databases/${databaseId}/collections/${selectedTable || collections[0]}/query`, parsed);
                        if (result.success) { setQueryResult(result.data); showToast('Opération exécutée', 'success'); } else showToast(result.error, 'error');
                    } catch (e) { showToast('JSON invalide', 'error'); }
                }
                setQueryLoading(false);
            };

            const startEditField = (col) => { setEditingField(col.Field); setEditValues({ type: col.Type, nullable: col.Null, defaultVal: col.Default || '', extra: col.Extra || '' }); };

            const saveFieldEdit = async () => {
                if (!editingField || !selectedTable) return;
                setSavingField(true);
                const nullPart = editValues.nullable === 'NO' ? 'NOT NULL' : 'NULL';
                const defPart = editValues.defaultVal ? ` DEFAULT '${editValues.defaultVal}'` : '';
                const extraPart = editValues.extra ? ` ${editValues.extra}` : '';
                const query = `ALTER TABLE \`${selectedTable}\` MODIFY COLUMN \`${editingField}\` ${editValues.type} ${nullPart}${defPart}${extraPart}`;
                const result = await api.post(`/api/databases/${databaseId}/query`, { query });
                setSavingField(false);
                if (result.success) { showToast(`Champ "${editingField}" modifié`, 'success'); setEditingField(null); loadTableStructure(selectedTable); }
                else showToast(result.error, 'error');
            };

            const handleAddField = async (e) => {
                e.preventDefault();
                if (!newField.name || !selectedTable) return;
                setAddFieldLoading(true);
                const nullPart = newField.nullable === 'NO' ? 'NOT NULL' : 'NULL';
                const defPart = newField.defaultVal ? ` DEFAULT '${newField.defaultVal}'` : '';
                const extraPart = newField.extra ? ` ${newField.extra}` : '';
                const query = `ALTER TABLE \`${selectedTable}\` ADD COLUMN \`${newField.name}\` ${newField.type} ${nullPart}${defPart}${extraPart}`;
                const result = await api.post(`/api/databases/${databaseId}/query`, { query });
                setAddFieldLoading(false);
                if (result.success) {
                    showToast(`Champ "${newField.name}" ajouté`, 'success');
                    setShowAddField(false); setNewField({ name: '', type: 'VARCHAR(255)', nullable: 'YES', defaultVal: '', extra: '' });
                    loadTableStructure(selectedTable);
                } else showToast(result.error, 'error');
            };

            const handleDeleteRow = async (row) => {
                setDeletingItem(true);
                const pkField = tableStructure.find(c => c.Key === 'PRI');
                const wherePart = pkField
                    ? `\`${pkField.Field}\` = '${String(row[pkField.Field]).replace(/'/g, "''")}' `
                    : Object.entries(row).map(([k, v]) => v === null ? `\`${k}\` IS NULL` : `\`${k}\` = '${String(v).replace(/'/g, "''")}'`).join(' AND ');
                const result = await api.post(`/api/databases/${databaseId}/query`, { query: `DELETE FROM \`${selectedTable}\` WHERE ${wherePart} LIMIT 1` });
                setDeletingItem(false);
                setConfirmDelete(null);
                if (result.success) { showToast('Ligne supprimée', 'success'); loadTableData(selectedTable, page * limit); }
                else showToast(result.error, 'error');
            };

            const handleDeleteDoc = async (doc) => {
                setDeletingItem(true);
                const result = await api.post(`/api/databases/${databaseId}/collections/${selectedTable}/query`, {
                    operation: 'deleteOne',
                    query: { _id: doc._id }
                });
                setDeletingItem(false);
                setConfirmDelete(null);
                if (result.success) { showToast('Document supprimé', 'success'); loadCollectionData(selectedTable, page * limit); }
                else showToast(result.error, 'error');
            };

            const startEditRow = (row, idx) => {
                setEditingRow(idx);
                setEditRowValues(Object.fromEntries(Object.entries(row).map(([k, v]) => [k, v === null || v === undefined ? '' : String(v)])));
            };

            const saveMysqlRowEdit = async () => {
                if (editingRow === null || !selectedTable) return;
                setSavingRow(true);
                const originalRow = tableData.rows[editingRow];
                const pkField = tableStructure.find(c => c.Key === 'PRI');
                const setParts = Object.entries(editRowValues)
                    .filter(([k]) => !pkField || k !== pkField.Field)
                    .map(([k, v]) => `\`${k}\` = ${v === '' ? 'NULL' : `'${v.replace(/'/g, "''")}'`}`)
                    .join(', ');
                const wherePart = pkField
                    ? `\`${pkField.Field}\` = '${String(originalRow[pkField.Field]).replace(/'/g, "''")}' `
                    : Object.entries(originalRow).map(([k, v]) => v === null ? `\`${k}\` IS NULL` : `\`${k}\` = '${String(v).replace(/'/g, "''")}'`).join(' AND ');
                const query = `UPDATE \`${selectedTable}\` SET ${setParts} WHERE ${wherePart} LIMIT 1`;
                const result = await api.post(`/api/databases/${databaseId}/query`, { query });
                setSavingRow(false);
                if (result.success) {
                    showToast('Ligne mise à jour', 'success');
                    setEditingRow(null);
                    loadTableData(selectedTable, page * limit);
                } else showToast(result.error, 'error');
            };

            const startEditDoc = (doc) => {
                const { _id, ...rest } = doc;
                const idStr = String(_id?.$oid || _id || '');
                setEditingDoc(idStr);
                setEditingDocRaw(_id);
                setEditDocValues(Object.fromEntries(Object.entries(rest).map(([k, v]) => [k, typeof v === 'object' ? JSON.stringify(v) : String(v ?? '')])));
            };

            const saveDocumentEdit = async () => {
                if (!editingDoc || !selectedTable) return;
                setSavingDoc(true);
                const updateFields = {};
                Object.entries(editDocValues).forEach(([k, v]) => {
                    try { updateFields[k] = JSON.parse(v); } catch { updateFields[k] = v; }
                });
                const result = await api.post(`/api/databases/${databaseId}/collections/${selectedTable}/query`, {
                    operation: 'updateOne',
                    query: { _id: editingDocRaw },
                    options: { update: { $set: updateFields } }
                });
                setSavingDoc(false);
                if (result.success) {
                    showToast('Document mis à jour', 'success');
                    setEditingDoc(null);
                    setEditingDocRaw(null);
                    loadCollectionData(selectedTable, page * limit);
                } else showToast(result.error, 'error');
            };

            const handlePageChange = (newPage) => {
                const offset = newPage * limit;
                if (database.type === 'mysql') loadTableData(selectedTable, offset);
                else loadCollectionData(selectedTable, offset);
            };

            if (loading) {
                return (
                    <div className="flex items-center justify-center h-64">
                        <div className="text-center">
                            <Icon name="loader-2" size={36} className="animate-spin text-primary-400 mx-auto mb-3" />
                            <p className="text-sm text-gray-500">Connexion à la base de données...</p>
                        </div>
                    </div>
                );
            }
            if (!database) return <div className="text-center py-16 text-gray-600">Base de données non trouvée</div>;

            const isMysql = database.type === 'mysql';
            const tableList = isMysql ? tables : collections;
            const totalPages = tableData ? Math.ceil((tableData.total || 0) / limit) : 0;

            const fieldTypeBadge = (type) => {
                const t = (type || '').toUpperCase();
                if (t.includes('INT') || t.includes('FLOAT') || t.includes('DOUBLE') || t.includes('DECIMAL')) return 'bg-blue-50 text-blue-700';
                if (t.includes('VARCHAR') || t.includes('TEXT') || t.includes('CHAR')) return 'bg-emerald-50 text-emerald-700';
                if (t.includes('DATE') || t.includes('TIME')) return 'bg-purple-50 text-purple-700';
                if (t.includes('BOOL')) return 'bg-amber-50 text-amber-700';
                return 'bg-gray-100 text-gray-600';
            };

            return (
                <div className="fade-in">
                    <button onClick={() => onNavigate('databases')} className="flex items-center gap-1.5 text-gray-500 hover:text-gray-900 text-sm mb-5 transition-colors">
                        <Icon name="arrow-left" size={15} /> Retour aux bases de données
                    </button>

                    <div className="bg-white border border-gray-200 rounded-2xl p-5 mb-5 shadow-sm">
                        <div className="flex items-center gap-4">
                            <div className={`w-14 h-14 rounded-2xl flex items-center justify-center shadow-md ${isMysql ? 'bg-gradient-to-br from-blue-500 to-blue-700' : 'bg-gradient-to-br from-green-500 to-green-700'}`}>
                                <Icon name="database" size={26} className="text-white" />
                            </div>
                            <div>
                                <h1 className="text-xl font-bold text-gray-900">{database.name}</h1>
                                <div className="flex items-center gap-2 mt-1">
                                    <span className={`text-xs px-2 py-0.5 rounded-full font-semibold ${isMysql ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}`}>{database.type.toUpperCase()}</span>
                                    <span className="text-xs text-gray-500">{database.host}:{database.port}</span>
                                    {database.username && <span className="text-xs text-gray-400">· {database.username}</span>}
                                </div>
                            </div>
                            <div className="ml-auto flex items-center gap-1.5 text-sm text-gray-400">
                                <Icon name={isMysql ? 'table' : 'layers'} size={14} />
                                {tableList.length} {isMysql ? 'table(s)' : 'collection(s)'}
                            </div>
                        </div>
                    </div>

                    {/* Collection / Table card grid — Compass style */}
                    <div className="mb-5">
                        <div className="flex items-center gap-2 mb-3">
                            <Icon name={isMysql ? 'table' : 'layers'} size={14} className="text-primary-600" />
                            <span className="font-semibold text-gray-900 text-sm">{isMysql ? 'Tables' : 'Collections'}</span>
                            <span className="text-xs bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded-full">{tableList.length}</span>
                        </div>
                        {tableList.length === 0 ? (
                            <div className="bg-white border border-gray-200 rounded-2xl py-8 text-center shadow-sm">
                                <Icon name={isMysql ? 'table' : 'layers'} size={28} className="text-gray-200 mx-auto mb-2" />
                                <p className="text-xs text-gray-400">Aucune {isMysql ? 'table' : 'collection'} trouvée</p>
                            </div>
                        ) : (
                            <div className="flex flex-wrap gap-2">
                                {tableList.map(name => (
                                    <button key={name} onClick={() => handleSelectTable(name)}
                                        className={`flex items-center gap-2 px-3.5 py-2 rounded-xl border text-sm font-medium transition-all ${
                                            selectedTable === name
                                                ? 'bg-primary-600 border-primary-600 text-white shadow-md shadow-primary-200'
                                                : 'bg-white border-gray-200 text-gray-700 hover:border-primary-300 hover:text-primary-700 hover:bg-primary-50 shadow-sm'
                                        }`}>
                                        <Icon name={isMysql ? 'table' : 'layers'} size={13} className={selectedTable === name ? 'text-primary-200' : 'text-gray-400'} />
                                        {name}
                                    </button>
                                ))}
                            </div>
                        )}
                    </div>

                    <div className="space-y-4">
                            {!selectedTable ? (
                                <div className="bg-white border border-gray-200 rounded-2xl p-16 text-center shadow-sm">
                                    <Icon name="mouse-pointer-click" size={40} className="text-gray-300 mx-auto mb-4" />
                                    <p className="text-gray-600 font-medium">Sélectionnez une {isMysql ? 'table' : 'collection'}</p>
                                    <p className="text-gray-400 text-sm mt-1">Cliquez sur une {isMysql ? 'table' : 'collection'} ci-dessus</p>
                                </div>
                            ) : null}
                            {selectedTable && (
                                <div className="flex gap-1 bg-gray-100 p-1 rounded-xl w-fit">
                                    {(isMysql ? [
                                        { id: 'fields', label: 'Champs', icon: 'columns' },
                                        { id: 'data', label: 'Données', icon: 'rows' },
                                        { id: 'query', label: 'SQL', icon: 'terminal' },
                                    ] : [
                                        { id: 'data', label: 'Documents', icon: 'rows' },
                                        { id: 'query', label: 'Opération', icon: 'terminal' },
                                    ]).map(v => (
                                        <button key={v.id} onClick={() => setActiveView(v.id)}
                                            className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${activeView === v.id ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>
                                            <Icon name={v.icon} size={14} /> {v.label}
                                        </button>
                                    ))}
                                </div>
                            )}
                            {selectedTable && activeView === 'query' && (
                                <div className="space-y-4">
                                    <div className="bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden">
                                        <div className="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                                            <h3 className="font-semibold text-gray-900 flex items-center gap-2 text-sm">
                                                <Icon name="terminal" size={15} className="text-primary-600" />
                                                {isMysql ? 'Éditeur SQL' : 'Opération MongoDB'}
                                            </h3>
                                            <button onClick={handleExecuteQuery} disabled={queryLoading || !queryText.trim()} className="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-primary-600 hover:bg-primary-700 text-white text-xs font-medium transition-colors disabled:opacity-50">
                                                {queryLoading ? <Icon name="loader-2" size={13} className="animate-spin" /> : <Icon name="play" size={13} />} Exécuter
                                            </button>
                                        </div>
                                        <div className="p-4">
                                            <textarea value={queryText} onChange={e => setQueryText(e.target.value)}
                                                placeholder={isMysql ? 'SELECT * FROM `' + selectedTable + '` LIMIT 10;' : '{"operation": "find", "query": {}, "options": {"limit": 10}}'}
                                                className="w-full h-36 px-3 py-2.5 bg-gray-50 border border-gray-200 rounded-xl text-sm font-mono text-gray-900 focus:outline-none focus:border-primary-400 resize-none" />
                                            <p className="text-xs text-gray-400 mt-2">{isMysql ? 'Requête SQL — SELECT, INSERT, UPDATE, ALTER...' : 'JSON avec les clés: operation, query, options'}</p>
                                        </div>
                                    </div>
                                    {queryResult && (
                                        <div className="bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden">
                                            <div className="px-5 py-3 border-b border-gray-100 flex items-center gap-2">
                                                <Icon name="check-circle" size={15} className="text-emerald-500" />
                                                <h3 className="font-semibold text-gray-900 text-sm">Résultat</h3>
                                            </div>
                                            <div className="p-4">
                                                <pre className="text-xs bg-gray-50 border border-gray-100 p-4 rounded-xl overflow-auto max-h-80 text-gray-700">{JSON.stringify(queryResult, null, 2)}</pre>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                            {selectedTable && activeView === 'fields' && isMysql && (
                                <div className="bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden">
                                    <div className="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                                        <h3 className="font-semibold text-gray-900 flex items-center gap-2 text-sm">
                                            <Icon name="columns" size={15} className="text-primary-600" />
                                            Champs — <code className="text-primary-700 bg-primary-50 px-1.5 py-0.5 rounded">{selectedTable}</code>
                                            <span className="text-xs bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded-full">{tableStructure.length}</span>
                                        </h3>
                                        <button onClick={() => setShowAddField(true)} className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-primary-600 hover:bg-primary-700 text-white text-xs font-medium transition-colors">
                                            <Icon name="plus" size={13} /> Nouveau champ
                                        </button>
                                    </div>
                                    {tableStructure.length === 0 ? (
                                        <div className="py-12 text-center">
                                            <Icon name="loader-2" size={22} className="animate-spin text-gray-300 mx-auto mb-2" />
                                            <p className="text-sm text-gray-400">Détection des champs...</p>
                                        </div>
                                    ) : (
                                        <div className="divide-y divide-gray-50">
                                            {tableStructure.map((col, i) => (
                                                <div key={i} className="px-5 py-3 hover:bg-gray-50/60 transition-colors group">
                                                    {editingField === col.Field ? (
                                                        <div className="space-y-3">
                                                            <div className="flex items-center gap-2">
                                                                <Icon name="pencil" size={13} className="text-primary-500" />
                                                                <span className="font-semibold text-gray-900 text-sm">Modifier : <code className="text-primary-700">{col.Field}</code></span>
                                                            </div>
                                                            <div className="grid grid-cols-2 gap-3">
                                                                <div>
                                                                    <label className="block text-xs font-medium text-gray-500 mb-1">Type</label>
                                                                    <select value={editValues.type} onChange={e => setEditValues({...editValues, type: e.target.value})} className="w-full px-2.5 py-1.5 bg-white border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-primary-500">
                                                                        {MYSQL_TYPES.map(t => <option key={t} value={t}>{t}</option>)}
                                                                        {!MYSQL_TYPES.includes(editValues.type) && <option value={editValues.type}>{editValues.type}</option>}
                                                                    </select>
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs font-medium text-gray-500 mb-1">Nullable</label>
                                                                    <select value={editValues.nullable} onChange={e => setEditValues({...editValues, nullable: e.target.value})} className="w-full px-2.5 py-1.5 bg-white border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-primary-500">
                                                                        <option value="YES">YES (NULL)</option>
                                                                        <option value="NO">NO (NOT NULL)</option>
                                                                    </select>
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs font-medium text-gray-500 mb-1">Valeur par défaut</label>
                                                                    <input type="text" value={editValues.defaultVal} onChange={e => setEditValues({...editValues, defaultVal: e.target.value})} placeholder="NULL ou valeur" className="w-full px-2.5 py-1.5 bg-white border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-primary-500" />
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs font-medium text-gray-500 mb-1">Extra</label>
                                                                    <input type="text" value={editValues.extra} onChange={e => setEditValues({...editValues, extra: e.target.value})} placeholder="AUTO_INCREMENT..." className="w-full px-2.5 py-1.5 bg-white border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-primary-500" />
                                                                </div>
                                                            </div>
                                                            <div className="flex gap-2">
                                                                <button onClick={saveFieldEdit} disabled={savingField} className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-primary-600 hover:bg-primary-700 text-white text-xs font-medium disabled:opacity-50 transition-colors">
                                                                    {savingField ? <Icon name="loader-2" size={12} className="animate-spin" /> : <Icon name="check" size={12} />} Enregistrer
                                                                </button>
                                                                <button onClick={() => setEditingField(null)} className="px-3 py-1.5 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-600 text-xs font-medium transition-colors">Annuler</button>
                                                            </div>
                                                        </div>
                                                    ) : (
                                                        <div className="flex items-center justify-between gap-4">
                                                            <div className="flex items-center gap-3 flex-1 min-w-0">
                                                                <div className="w-8 h-8 bg-gray-50 border border-gray-100 rounded-lg flex items-center justify-center shrink-0">
                                                                    <Icon name="hash" size={13} className="text-gray-400" />
                                                                </div>
                                                                <div className="min-w-0">
                                                                    <div className="flex items-center gap-2 flex-wrap">
                                                                        <span className="font-semibold text-gray-900 text-sm">{col.Field}</span>
                                                                        {col.Key === 'PRI' && <span className="text-xs bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded-full font-medium">PK</span>}
                                                                        {col.Key === 'UNI' && <span className="text-xs bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded-full font-medium">UNI</span>}
                                                                        {col.Key === 'MUL' && <span className="text-xs bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded-full font-medium">IDX</span>}
                                                                    </div>
                                                                    <div className="flex items-center gap-2 mt-0.5 flex-wrap">
                                                                        <span className={`text-xs px-2 py-0.5 rounded-full font-mono font-medium ${fieldTypeBadge(col.Type)}`}>{col.Type}</span>
                                                                        <span className={`text-xs ${col.Null === 'NO' ? 'text-red-400' : 'text-gray-400'}`}>{col.Null === 'NO' ? 'NOT NULL' : 'NULL'}</span>
                                                                        {col.Default !== null && col.Default !== undefined && <span className="text-xs text-gray-400">défaut: <code className="bg-gray-100 px-1 rounded">{col.Default || 'NULL'}</code></span>}
                                                                        {col.Extra && <span className="text-xs text-indigo-500 font-medium">{col.Extra}</span>}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <button onClick={() => startEditField(col)} className="opacity-0 group-hover:opacity-100 p-1.5 rounded-lg hover:bg-primary-50 text-gray-400 hover:text-primary-600 transition-all" title="Modifier">
                                                                <Icon name="pencil" size={14} />
                                                            </button>
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}

                            {selectedTable && activeView === 'data' && (
                                <div className="bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden">
                                    <div className="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                                        <h3 className="font-semibold text-gray-900 flex items-center gap-2 text-sm">
                                            <Icon name="rows" size={15} className="text-primary-600" />
                                            Données — <code className="text-primary-700 bg-primary-50 px-1.5 py-0.5 rounded">{selectedTable}</code>
                                            {tableData && <span className="text-xs bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded-full">{tableData.total} {isMysql ? 'lignes' : 'docs'}</span>}
                                        </h3>
                                        {totalPages > 1 && (
                                            <div className="flex items-center gap-2">
                                                <button onClick={() => handlePageChange(page - 1)} disabled={page === 0} className="p-1.5 rounded-lg hover:bg-gray-100 disabled:opacity-40 transition-colors"><Icon name="chevron-left" size={14} /></button>
                                                <span className="text-xs text-gray-600 font-medium">{page + 1} / {totalPages}</span>
                                                <button onClick={() => handlePageChange(page + 1)} disabled={page >= totalPages - 1} className="p-1.5 rounded-lg hover:bg-gray-100 disabled:opacity-40 transition-colors"><Icon name="chevron-right" size={14} /></button>
                                            </div>
                                        )}
                                    </div>
                                    {dataLoading ? (
                                        <div className="py-12 text-center"><Icon name="loader-2" size={24} className="animate-spin text-gray-300 mx-auto" /></div>
                                    ) : !tableData ? (
                                        <div className="py-12 text-center text-gray-400 text-sm">Aucune donnée</div>
                                    ) : isMysql ? (
                                        <div className="p-4 space-y-2">
                                            {(tableData.rows || []).length === 0 ? (
                                                <div className="py-8 text-center text-gray-400 text-sm">Aucune ligne</div>
                                            ) : tableData.rows.map((row, i) => {
                                                const isEditing = editingRow === i;
                                                const pkField = tableStructure.find(c => c.Key === 'PRI');
                                                return (
                                                    <div key={i} className={`group border rounded-xl px-4 py-3 transition-all ${isEditing ? 'border-primary-300 bg-primary-50/30 shadow-sm' : 'border-gray-100 bg-gray-50/50 hover:border-gray-200 hover:bg-white hover:shadow-sm'}`}>
                                                        <div className="flex items-start justify-between gap-3">
                                                            <div className="flex flex-wrap gap-x-4 gap-y-2 flex-1 min-w-0">
                                                                {tableData.fields?.map((f, j) => {
                                                                    const isPk = pkField && f.name === pkField.Field;
                                                                    return (
                                                                        <div key={j} className="flex flex-col gap-0.5 min-w-0">
                                                                            <span className="text-[10px] font-semibold text-gray-400 uppercase tracking-wide flex items-center gap-1">
                                                                                {f.name}
                                                                                {isPk && <span className="text-amber-500">★</span>}
                                                                            </span>
                                                                            {isEditing ? (
                                                                                isPk ? (
                                                                                    <span className="text-xs text-gray-400 font-mono px-2 py-1 bg-gray-100 rounded-lg">{String(row[f.name] ?? '')}</span>
                                                                                ) : (
                                                                                    <input
                                                                                        type="text"
                                                                                        value={editRowValues[f.name] ?? ''}
                                                                                        onChange={e => setEditRowValues({...editRowValues, [f.name]: e.target.value})}
                                                                                        className="px-2 py-1 bg-white border border-primary-300 rounded-lg text-xs focus:outline-none focus:border-primary-500 focus:ring-1 focus:ring-primary-500/20 w-32"
                                                                                    />
                                                                                )
                                                                            ) : (
                                                                                <span className="text-xs text-gray-800 font-medium max-w-[160px] truncate" title={String(row[f.name] ?? '')}>
                                                                                    {row[f.name] !== null && row[f.name] !== undefined
                                                                                        ? String(row[f.name])
                                                                                        : <span className="text-gray-300 italic font-normal">null</span>}
                                                                                </span>
                                                                            )}
                                                                        </div>
                                                                    );
                                                                })}
                                                            </div>
                                                            <div className="shrink-0">
                                                                {isEditing ? (
                                                                    <div className="flex items-center gap-1">
                                                                        <button onClick={saveMysqlRowEdit} disabled={savingRow} className="flex items-center gap-1 px-2.5 py-1.5 rounded-lg bg-primary-600 hover:bg-primary-700 text-white text-xs font-medium disabled:opacity-50 transition-colors">
                                                                            {savingRow ? <Icon name="loader-2" size={11} className="animate-spin" /> : <Icon name="check" size={11} />}
                                                                            Sauv.
                                                                        </button>
                                                                        <button onClick={() => setEditingRow(null)} className="p-1.5 rounded-lg hover:bg-gray-200 text-gray-500 transition-colors">
                                                                            <Icon name="x" size={13} />
                                                                        </button>
                                                                    </div>
                                                                ) : confirmDelete === i ? (
                                                                    <div className="flex items-center gap-1">
                                                                        <span className="text-xs text-red-600 font-medium">Supprimer ?</span>
                                                                        <button onClick={() => handleDeleteRow(row)} disabled={deletingItem} className="flex items-center gap-1 px-2 py-1 rounded-lg bg-red-600 hover:bg-red-700 text-white text-xs font-medium disabled:opacity-50 transition-colors">
                                                                            {deletingItem ? <Icon name="loader-2" size={11} className="animate-spin" /> : <Icon name="check" size={11} />}
                                                                        </button>
                                                                        <button onClick={() => setConfirmDelete(null)} className="p-1 rounded-lg hover:bg-gray-200 text-gray-500 transition-colors">
                                                                            <Icon name="x" size={13} />
                                                                        </button>
                                                                    </div>
                                                                ) : (
                                                                    <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-all">
                                                                        <button onClick={() => startEditRow(row, i)} className="p-1.5 rounded-lg hover:bg-primary-50 text-gray-400 hover:text-primary-600 transition-colors" title="Modifier">
                                                                            <Icon name="pencil" size={13} />
                                                                        </button>
                                                                        <button onClick={() => setConfirmDelete(i)} className="p-1.5 rounded-lg hover:bg-red-50 text-gray-400 hover:text-red-500 transition-colors" title="Supprimer">
                                                                            <Icon name="trash-2" size={13} />
                                                                        </button>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    ) : (
                                        <div className="p-4 space-y-2">
                                            {!tableData.documents || tableData.documents.length === 0 ? (
                                                <div className="py-8 text-center text-gray-400 text-sm">Aucun document</div>
                                            ) : tableData.documents.map((doc, i) => {
                                                const docId = String(doc._id?.$oid || doc._id || i);
                                                const isEditing = editingDoc === docId;
                                                const entries = Object.entries(doc).filter(([k]) => k !== '_id');
                                                return (
                                                    <div key={i} className={`group border rounded-xl px-4 py-3 transition-all ${isEditing ? 'border-primary-300 bg-primary-50/30 shadow-sm' : 'border-gray-100 bg-gray-50/50 hover:border-gray-200 hover:bg-white hover:shadow-sm'}`}>
                                                        <div className="flex items-start justify-between gap-3">
                                                            <div className="flex flex-wrap gap-x-4 gap-y-2 flex-1 min-w-0">
                                                                <div className="flex flex-col gap-0.5">
                                                                    <span className="text-[10px] font-semibold text-gray-400 uppercase tracking-wide">_id</span>
                                                                    <span className="text-xs text-gray-400 font-mono">{docId.slice(-10)}…</span>
                                                                </div>
                                                                {entries.map(([k, v]) => (
                                                                    <div key={k} className="flex flex-col gap-0.5 min-w-0">
                                                                        <span className="text-[10px] font-semibold text-gray-400 uppercase tracking-wide">{k}</span>
                                                                        {isEditing ? (
                                                                            <input
                                                                                type="text"
                                                                                value={editDocValues[k] ?? ''}
                                                                                onChange={e => setEditDocValues({...editDocValues, [k]: e.target.value})}
                                                                                className="px-2 py-1 bg-white border border-primary-300 rounded-lg text-xs focus:outline-none focus:border-primary-500 focus:ring-1 focus:ring-primary-500/20 w-32"
                                                                            />
                                                                        ) : (
                                                                            <span className="text-xs text-gray-800 font-medium max-w-[160px] truncate" title={String(v ?? '')}>
                                                                                {v === null || v === undefined
                                                                                    ? <span className="text-gray-300 italic font-normal">null</span>
                                                                                    : typeof v === 'object'
                                                                                        ? <span className="text-purple-600 font-mono">{JSON.stringify(v).slice(0, 40)}</span>
                                                                                        : String(v)}
                                                                            </span>
                                                                        )}
                                                                    </div>
                                                                ))}
                                                            </div>
                                                            <div className="shrink-0">
                                                                {isEditing ? (
                                                                    <div className="flex items-center gap-1">
                                                                        <button onClick={saveDocumentEdit} disabled={savingDoc} className="flex items-center gap-1 px-2.5 py-1.5 rounded-lg bg-primary-600 hover:bg-primary-700 text-white text-xs font-medium disabled:opacity-50 transition-colors">
                                                                            {savingDoc ? <Icon name="loader-2" size={11} className="animate-spin" /> : <Icon name="check" size={11} />}
                                                                            Sauv.
                                                                        </button>
                                                                        <button onClick={() => { setEditingDoc(null); setEditingDocRaw(null); }} className="p-1.5 rounded-lg hover:bg-gray-200 text-gray-500 transition-colors">
                                                                            <Icon name="x" size={13} />
                                                                        </button>
                                                                    </div>
                                                                ) : confirmDelete === docId ? (
                                                                    <div className="flex items-center gap-1">
                                                                        <span className="text-xs text-red-600 font-medium">Supprimer ?</span>
                                                                        <button onClick={() => handleDeleteDoc(doc)} disabled={deletingItem} className="flex items-center gap-1 px-2 py-1 rounded-lg bg-red-600 hover:bg-red-700 text-white text-xs font-medium disabled:opacity-50 transition-colors">
                                                                            {deletingItem ? <Icon name="loader-2" size={11} className="animate-spin" /> : <Icon name="check" size={11} />}
                                                                        </button>
                                                                        <button onClick={() => setConfirmDelete(null)} className="p-1 rounded-lg hover:bg-gray-200 text-gray-500 transition-colors">
                                                                            <Icon name="x" size={13} />
                                                                        </button>
                                                                    </div>
                                                                ) : (
                                                                    <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-all">
                                                                        <button onClick={() => startEditDoc(doc)} className="p-1.5 rounded-lg hover:bg-primary-50 text-gray-400 hover:text-primary-600 transition-colors" title="Modifier">
                                                                            <Icon name="pencil" size={13} />
                                                                        </button>
                                                                        <button onClick={() => setConfirmDelete(docId)} className="p-1.5 rounded-lg hover:bg-red-50 text-gray-400 hover:text-red-500 transition-colors" title="Supprimer">
                                                                            <Icon name="trash-2" size={13} />
                                                                        </button>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            )}
                    </div>

                    {showAddField && (
                        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md">
                                <div className="px-6 py-5 border-b border-gray-100 flex items-center justify-between">
                                    <h2 className="font-bold text-gray-900 flex items-center gap-2">
                                        <Icon name="plus-circle" size={18} className="text-primary-600" />
                                        Nouveau champ — <code className="text-primary-700 text-sm">{selectedTable}</code>
                                    </h2>
                                    <button onClick={() => setShowAddField(false)} className="p-1.5 rounded-lg hover:bg-gray-100 text-gray-400 transition-colors"><Icon name="x" size={16} /></button>
                                </div>
                                <form onSubmit={handleAddField} className="p-6 space-y-4">
                                    <div>
                                        <label className="block text-xs font-semibold text-gray-600 mb-1.5">Nom du champ <span className="text-red-500">*</span></label>
                                        <input type="text" value={newField.name} onChange={e => setNewField({...newField, name: e.target.value})} required placeholder="ex: email, created_at..." className="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-xl text-sm focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/10" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-semibold text-gray-600 mb-1.5">Type</label>
                                        <select value={newField.type} onChange={e => setNewField({...newField, type: e.target.value})} className="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-xl text-sm focus:outline-none focus:border-primary-500">
                                            {MYSQL_TYPES.map(t => <option key={t} value={t}>{t}</option>)}
                                        </select>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="block text-xs font-semibold text-gray-600 mb-1.5">Nullable</label>
                                            <select value={newField.nullable} onChange={e => setNewField({...newField, nullable: e.target.value})} className="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-xl text-sm focus:outline-none focus:border-primary-500">
                                                <option value="YES">YES (NULL)</option>
                                                <option value="NO">NO (NOT NULL)</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-semibold text-gray-600 mb-1.5">Valeur par défaut</label>
                                            <input type="text" value={newField.defaultVal} onChange={e => setNewField({...newField, defaultVal: e.target.value})} placeholder="NULL ou valeur" className="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-xl text-sm focus:outline-none focus:border-primary-500" />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-semibold text-gray-600 mb-1.5">Extra</label>
                                        <input type="text" value={newField.extra} onChange={e => setNewField({...newField, extra: e.target.value})} placeholder="AUTO_INCREMENT, ON UPDATE CURRENT_TIMESTAMP..." className="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-xl text-sm focus:outline-none focus:border-primary-500" />
                                    </div>
                                    <div className="flex gap-3 pt-2">
                                        <button type="button" onClick={() => setShowAddField(false)} className="flex-1 px-4 py-2.5 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm font-medium transition-colors">Annuler</button>
                                        <button type="submit" disabled={addFieldLoading || !newField.name.trim()} className="flex-1 flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl bg-primary-600 hover:bg-primary-700 text-white text-sm font-medium transition-colors disabled:opacity-50">
                                            {addFieldLoading ? <Icon name="loader-2" size={14} className="animate-spin" /> : <Icon name="plus" size={14} />}
                                            Ajouter le champ
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Database Card Component
        function DatabaseCard({ database, onEdit, onDelete, showToast, isAdmin, projects, onRefresh, onNavigate }) {
            const [showConnectionString, setShowConnectionString] = useState(false);
            const [connectionString, setConnectionString] = useState('');
            const [testingConnection, setTestingConnection] = useState(false);
            const [connectionStatus, setConnectionStatus] = useState(null);

            const project = projects.find(p => p.name === database.projectName);
            const typeColor = database.type === 'mysql' ? 'blue' : 'green';
            const typeIcon = database.type === 'mysql' ? 'database' : 'leaf';

            async function handleGetConnectionString() {
                const result = await api.get(`/api/databases/${database.id}/connection-string`);
                if (result.success) {
                    setConnectionString(result.data.connectionString);
                    setShowConnectionString(true);
                } else {
                    showToast(result.error, 'error');
                }
            }

            async function handleTestConnection() {
                setTestingConnection(true);
                setConnectionStatus(null);
                const endpoint = database.type === 'mysql' 
                    ? `/api/databases/${database.id}/test-mysql`
                    : `/api/databases/${database.id}/test-mongo`;
                const result = await api.post(endpoint);
                setTestingConnection(false);
                setConnectionStatus(result.success);
                showToast(
                    result.success ? '✅ Connexion réussie' : `❌ ${result.error}`,
                    result.success ? 'success' : 'error'
                );
            }

            async function handleAssignProject(projectName) {
                const result = await api.post(`/api/databases/${database.id}/assign`, { projectName });
                showToast(result.success ? 'Projet assigné' : result.error, result.success ? 'success' : 'error');
                if (result.success) onRefresh();
            }

            async function handleUnassign() {
                const result = await api.post(`/api/databases/${database.id}/unassign`);
                showToast(result.success ? 'Assignation retirée' : result.error, result.success ? 'success' : 'error');
                if (result.success) onRefresh();
            }

            function copyToClipboard(text) {
                navigator.clipboard.writeText(text);
                showToast('Copié dans le presse-papier', 'success');
            }

            return (
                <div className="bg-white border border-gray-200 rounded-lg p-3 hover:border-primary-300 hover:shadow-md transition-all duration-200">
                    <div className="flex items-start justify-between mb-2">
                        <div className="flex items-center gap-2">
                            <div className={`w-8 h-8 ${database.type === 'mysql' ? 'bg-gradient-to-br from-blue-50 to-blue-100' : 'bg-gradient-to-br from-green-50 to-green-100'} rounded-lg flex items-center justify-center`}>
                                <Icon name={typeIcon} size={16} className={database.type === 'mysql' ? 'text-blue-600' : 'text-green-600'} />
                            </div>
                            <div>
                                <div className="flex items-center gap-1.5">
                                    <h3 className="font-semibold text-gray-900 text-sm">{database.name}</h3>
                                    {connectionStatus !== null && (
                                        <span className={`w-1.5 h-1.5 rounded-full ${connectionStatus ? 'bg-green-500' : 'bg-red-500'}`} title={connectionStatus ? 'Connecté' : 'Déconnecté'}></span>
                                    )}
                                </div>
                                <div className="flex items-center gap-1.5 mt-0.5">
                                    <span className={`text-[10px] px-1.5 py-0.5 rounded font-semibold ${database.type === 'mysql' ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}`}>
                                        {database.type.toUpperCase()}
                                    </span>
                                    {database.projectName && (
                                        <span className="text-[10px] px-1.5 py-0.5 rounded bg-purple-100 text-purple-700 font-medium flex items-center gap-0.5">
                                            <Icon name="folder" size={10} />
                                            {database.projectName}
                                        </span>
                                    )}
                                    <span className="text-[10px] text-gray-500">
                                        {database.host}:{database.port}
                                    </span>
                                </div>
                            </div>
                        </div>
                        {isAdmin && (
                            <div className="flex gap-0.5">
                                <button onClick={onEdit} className="p-1.5 rounded hover:bg-blue-50 text-gray-600 hover:text-blue-600 transition-colors" title="Modifier">
                                    <Icon name="settings" size={14} />
                                </button>
                                <button onClick={onDelete} className="p-1.5 rounded hover:bg-red-50 text-gray-600 hover:text-red-600 transition-colors" title="Supprimer">
                                    <Icon name="trash-2" size={14} />
                                </button>
                            </div>
                        )}
                    </div>

                    <div className="flex flex-wrap gap-1.5 mt-2">
                        <button 
                            onClick={() => onNavigate('database-editor', database.id)} 
                            className="flex-1 min-w-[100px] flex items-center justify-center gap-1.5 px-3 py-1.5 rounded-lg bg-gradient-to-r from-primary-600 to-primary-700 hover:from-primary-700 hover:to-primary-800 text-white text-xs font-semibold shadow-sm hover:shadow-md transition-all"
                        >
                            <Icon name="terminal" size={13} />
                            Éditeur
                        </button>
                        
                        <button 
                            onClick={handleTestConnection}
                            disabled={testingConnection}
                            className="flex items-center justify-center gap-1 px-2.5 py-1.5 rounded-lg bg-white border border-gray-200 hover:border-primary-300 hover:bg-primary-50 text-gray-700 hover:text-primary-700 text-xs font-medium transition-all disabled:opacity-50"
                            title="Tester la connexion"
                        >
                            {testingConnection ? (
                                <Icon name="loader-2" size={13} className="animate-spin" />
                            ) : (
                                <Icon name="activity" size={13} />
                            )}
                        </button>

                        <button 
                            onClick={handleGetConnectionString} 
                            className="flex items-center justify-center gap-1 px-2.5 py-1.5 rounded-lg bg-white border border-gray-200 hover:border-primary-300 hover:bg-primary-50 text-gray-700 hover:text-primary-700 text-xs font-medium transition-all"
                            title="Chaîne de connexion"
                        >
                            <Icon name="link" size={13} />
                        </button>

                        {isAdmin && !database.projectName && (
                            <select 
                                onChange={(e) => e.target.value && handleAssignProject(e.target.value)}
                                className="px-2.5 py-1.5 rounded-lg bg-white border border-gray-200 hover:border-primary-300 text-gray-700 text-xs font-medium cursor-pointer transition-all focus:outline-none focus:border-primary-500"
                            >
                                <option value="">📁 Projet</option>
                                {projects.map(p => (
                                    <option key={p.name} value={p.name}>{p.name}</option>
                                ))}
                            </select>
                        )}
                        
                        {isAdmin && database.projectName && (
                            <button 
                                onClick={handleUnassign} 
                                className="flex items-center gap-1 px-2.5 py-1.5 rounded-lg bg-red-50 border border-red-200 hover:bg-red-100 hover:border-red-300 text-red-700 text-xs font-medium transition-all"
                                title="Retirer l'assignation"
                            >
                                <Icon name="x-circle" size={13} />
                            </button>
                        )}
                    </div>

                    {showConnectionString && (
                        <div className="mt-4 p-4 bg-gradient-to-r from-gray-50 to-gray-100 border-2 border-gray-200 rounded-lg">
                            <div className="flex items-center justify-between mb-2">
                                <span className="text-xs font-bold text-gray-700 uppercase tracking-wide">Chaîne de connexion</span>
                                <button 
                                    onClick={() => copyToClipboard(connectionString)} 
                                    className="text-xs text-primary-600 hover:text-primary-700 font-semibold flex items-center gap-1.5 px-2 py-1 rounded hover:bg-white transition-colors"
                                >
                                    <Icon name="copy" size={14} /> Copier
                                </button>
                            </div>
                            <code className="text-xs text-gray-900 break-all font-mono bg-white px-3 py-2 rounded border border-gray-200 block">{connectionString}</code>
                        </div>
                    )}
                </div>
            );
        }

        // Create Database Modal
        function CreateDatabaseModal({ onClose, onSuccess, showToast, projects }) {
            const [dbType, setDbType] = useState('mysql');
            const [form, setForm] = useState({
                name: '',
                host: 'localhost',
                port: dbType === 'mysql' ? '3306' : '27017',
                username: '',
                password: '',
                authDatabase: 'admin',
                projectName: ''
            });
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                setForm(prev => ({ ...prev, port: dbType === 'mysql' ? '3306' : '27017' }));
            }, [dbType]);

            async function handleSubmit(e) {
                e.preventDefault();
                setLoading(true);
                const endpoint = dbType === 'mysql' ? '/api/databases/mysql' : '/api/databases/mongodb';
                const result = await api.post(endpoint, form);
                setLoading(false);

                if (result.success) {
                    showToast('Base de données créée', 'success');
                    onSuccess();
                } else {
                    showToast(result.error, 'error');
                }
            }

            return (
                <Modal title="Nouvelle base de données" onClose={onClose} wide={true}>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Type de base de données</label>
                            <div className="grid grid-cols-2 gap-3">
                                <button
                                    type="button"
                                    onClick={() => setDbType('mysql')}
                                    className={`p-4 rounded-lg border-2 transition-all ${dbType === 'mysql' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'}`}
                                >
                                    <Icon name="database" size={24} className={dbType === 'mysql' ? 'text-blue-600' : 'text-gray-400'} />
                                    <p className={`mt-2 font-medium ${dbType === 'mysql' ? 'text-blue-900' : 'text-gray-700'}`}>MySQL</p>
                                </button>
                                <button
                                    type="button"
                                    onClick={() => setDbType('mongodb')}
                                    className={`p-4 rounded-lg border-2 transition-all ${dbType === 'mongodb' ? 'border-green-500 bg-green-50' : 'border-gray-200 hover:border-gray-300'}`}
                                >
                                    <Icon name="database" size={24} className={dbType === 'mongodb' ? 'text-green-600' : 'text-gray-400'} />
                                    <p className={`mt-2 font-medium ${dbType === 'mongodb' ? 'text-green-900' : 'text-gray-700'}`}>MongoDB</p>
                                </button>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Nom de la base</label>
                                <input
                                    type="text"
                                    value={form.name}
                                    onChange={e => setForm({...form, name: e.target.value})}
                                    required
                                    className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Projet (optionnel)</label>
                                <select
                                    value={form.projectName}
                                    onChange={e => setForm({...form, projectName: e.target.value})}
                                    className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:border-primary-500"
                                >
                                    <option value="">Aucun projet</option>
                                    {projects.map(p => (
                                        <option key={p.name} value={p.name}>{p.name}</option>
                                    ))}
                                </select>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Hôte</label>
                                <input
                                    type="text"
                                    value={form.host}
                                    onChange={e => setForm({...form, host: e.target.value})}
                                    required
                                    className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:border-primary-500"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Port</label>
                                <input
                                    type="number"
                                    value={form.port}
                                    onChange={e => setForm({...form, port: e.target.value})}
                                    required
                                    className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:border-primary-500"
                                />
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Utilisateur {dbType === 'mongodb' && '(optionnel)'}
                                </label>
                                <input
                                    type="text"
                                    value={form.username}
                                    onChange={e => setForm({...form, username: e.target.value})}
                                    required={dbType === 'mysql'}
                                    className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:border-primary-500"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Mot de passe {dbType === 'mongodb' && '(optionnel)'}
                                </label>
                                <input
                                    type="password"
                                    value={form.password}
                                    onChange={e => setForm({...form, password: e.target.value})}
                                    required={dbType === 'mysql'}
                                    className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:border-primary-500"
                                />
                            </div>
                        </div>

                        {dbType === 'mongodb' && (
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Base d'authentification</label>
                                <input
                                    type="text"
                                    value={form.authDatabase}
                                    onChange={e => setForm({...form, authDatabase: e.target.value})}
                                    className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:border-primary-500"
                                />
                            </div>
                        )}

                        <div className="flex justify-end gap-3 pt-4">
                            <button type="button" onClick={onClose} className="px-4 py-2 rounded-lg bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 transition-colors">
                                Annuler
                            </button>
                            <button type="submit" disabled={loading} className="px-4 py-2 rounded-lg bg-primary-600 hover:bg-primary-700 text-white transition-colors disabled:opacity-50">
                                {loading ? 'Création...' : 'Créer'}
                            </button>
                        </div>
                    </form>
                </Modal>
            );
        }

        // Edit Database Modal
        function EditDatabaseModal({ database, onClose, onSuccess, showToast, projects }) {
            const [form, setForm] = useState({
                host: database.host,
                port: database.port,
                username: database.username,
                password: database.password,
                authDatabase: database.authDatabase || 'admin'
            });
            const [loading, setLoading] = useState(false);

            async function handleSubmit(e) {
                e.preventDefault();
                setLoading(true);
                const result = await api.put(`/api/databases/${database.id}`, form);
                setLoading(false);

                if (result.success) {
                    showToast('Base de données mise à jour', 'success');
                    onSuccess();
                } else {
                    showToast(result.error, 'error');
                }
            }

            return (
                <Modal title={`Modifier: ${database.name}`} onClose={onClose}>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Hôte</label>
                                <input
                                    type="text"
                                    value={form.host}
                                    onChange={e => setForm({...form, host: e.target.value})}
                                    required
                                    className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:border-primary-500"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Port</label>
                                <input
                                    type="number"
                                    value={form.port}
                                    onChange={e => setForm({...form, port: e.target.value})}
                                    required
                                    className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:border-primary-500"
                                />
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Utilisateur</label>
                                <input
                                    type="text"
                                    value={form.username}
                                    onChange={e => setForm({...form, username: e.target.value})}
                                    className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:border-primary-500"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Mot de passe</label>
                                <input
                                    type="password"
                                    value={form.password}
                                    onChange={e => setForm({...form, password: e.target.value})}
                                    placeholder="Laisser vide pour ne pas changer"
                                    className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:border-primary-500"
                                />
                            </div>
                        </div>

                        {database.type === 'mongodb' && (
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Base d'authentification</label>
                                <input
                                    type="text"
                                    value={form.authDatabase}
                                    onChange={e => setForm({...form, authDatabase: e.target.value})}
                                    className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:border-primary-500"
                                />
                            </div>
                        )}

                        <div className="flex justify-end gap-3 pt-4">
                            <button type="button" onClick={onClose} className="px-4 py-2 rounded-lg bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 transition-colors">
                                Annuler
                            </button>
                            <button type="submit" disabled={loading} className="px-4 py-2 rounded-lg bg-primary-600 hover:bg-primary-700 text-white transition-colors disabled:opacity-50">
                                {loading ? 'Mise à jour...' : 'Mettre à jour'}
                            </button>
                        </div>
                    </form>
                </Modal>
            );
        }

        // ============================================
        // PM2 Status Page
        // ============================================
        function PM2StatusPage({ showToast }) {
            const [processes, setProcesses] = useState([]);
            const [loading, setLoading] = useState(true);

            const load = useCallback(async () => {
                const result = await api.get('/api/pm2/status');
                if (result.success) setProcesses(result.data || []);
                setLoading(false);
            }, []);

            useEffect(() => { load(); }, [load]);

            return (
                <div className="fade-in">
                    <div className="flex items-center justify-between mb-8">
                        <div>
                            <h1 className="text-2xl font-bold text-gray-900">Statut PM2</h1>
                            <p className="text-gray-600 mt-1">Tous les processus PM2 en cours</p>
                        </div>
                        <button onClick={() => { setLoading(true); load(); }} className="flex items-center gap-2 px-4 py-2 rounded-lg bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 transition-colors text-sm">
                            <Icon name="refresh-cw" size={15} /> Rafraîchir
                        </button>
                    </div>

                    {loading ? (
                        <div className="flex items-center justify-center h-64"><Icon name="loader-2" size={32} className="animate-spin text-gray-400" /></div>
                    ) : processes.length === 0 ? (
                        <div className="bg-white border border-gray-200 rounded-xl px-6 py-16 text-center shadow-sm">
                            <Icon name="activity" size={48} className="text-gray-300 mx-auto mb-4" />
                            <p className="text-gray-600 text-lg">Aucun processus PM2</p>
                        </div>
                    ) : (
                        <div className="bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm">
                            <table className="w-full">
                                <thead>
                                    <tr className="border-b border-gray-200 bg-gray-50">
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase">Nom</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase">Statut</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase">PID</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase">CPU</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase">Mémoire</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase">Restarts</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase">Uptime</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200">
                                    {processes.map((proc, i) => (
                                        <tr key={i} className="hover:bg-gray-50 transition-colors">
                                            <td className="px-6 py-3 text-sm font-medium text-gray-900">{proc.name}</td>
                                            <td className="px-6 py-3"><StatusBadge status={proc.pm2_env?.status} /></td>
                                            <td className="px-6 py-3 text-sm text-gray-600">{proc.pid || '-'}</td>
                                            <td className="px-6 py-3 text-sm text-gray-600">{proc.monit?.cpu != null ? `${proc.monit.cpu}%` : '-'}</td>
                                            <td className="px-6 py-3 text-sm text-gray-600">{proc.monit?.memory ? `${Math.round(proc.monit.memory / 1024 / 1024)} MB` : '-'}</td>
                                            <td className="px-6 py-3 text-sm text-gray-600">{proc.pm2_env?.restart_time || 0}</td>
                                            <td className="px-6 py-3 text-sm text-gray-600">
                                                {proc.pm2_env?.pm_uptime ? new Date(proc.pm2_env.pm_uptime).toLocaleString('fr-FR') : '-'}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        }

        // ============================================
        // Force Change Password Page
        // ============================================
        function ForceChangePasswordPage({ user, showToast, onDone, onCancel }) {
            const [form, setForm] = useState({ password: '', confirmPassword: '' });
            const [loading, setLoading] = useState(false);

            async function handleSubmit(e) {
                e.preventDefault();
                if (form.password !== form.confirmPassword) {
                    showToast('Les mots de passe ne correspondent pas', 'error');
                    return;
                }
                setLoading(true);
                const result = await api.put(`/api/users/${user.id}/password`, { password: form.password });
                setLoading(false);
                if (result.success) {
                    showToast('Mot de passe mis à jour', 'success');
                    onDone();
                } else {
                    showToast(result.error, 'error');
                }
            }

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50 px-4">
                    <div className="w-full max-w-md fade-in">
                        <div className="bg-white rounded-2xl shadow-xl border border-amber-200 overflow-hidden">
                            <div className="bg-amber-50 border-b border-amber-200 px-6 py-5 flex items-center gap-3">
                                <div className="w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center shrink-0">
                                    <Icon name="key" size={20} className="text-amber-600" />
                                </div>
                                <div>
                                    <h2 className="font-bold text-amber-900">Changement de mot de passe requis</h2>
                                    <p className="text-xs text-amber-700 mt-0.5">Bonjour <strong>{user.username}</strong>, vous devez définir un nouveau mot de passe avant de continuer.</p>
                                </div>
                            </div>
                            <form onSubmit={handleSubmit} className="p-6 space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1.5 flex items-center gap-2">
                                        <Icon name="lock" size={14} /> Nouveau mot de passe
                                    </label>
                                    <input
                                        type="password"
                                        value={form.password}
                                        onChange={e => setForm({...form, password: e.target.value})}
                                        minLength={6}
                                        required
                                        autoFocus
                                        placeholder="Minimum 6 caractères"
                                        className="w-full px-3 py-2 bg-white border border-gray-300 rounded-xl text-gray-900 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/10 text-sm"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1.5 flex items-center gap-2">
                                        <Icon name="shield-check" size={14} /> Confirmer le mot de passe
                                    </label>
                                    <input
                                        type="password"
                                        value={form.confirmPassword}
                                        onChange={e => setForm({...form, confirmPassword: e.target.value})}
                                        minLength={6}
                                        required
                                        placeholder="Répétez le mot de passe"
                                        className="w-full px-3 py-2 bg-white border border-gray-300 rounded-xl text-gray-900 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/10 text-sm"
                                    />
                                </div>
                                <div className="flex gap-3 pt-2">
                                    <button type="button" onClick={onCancel} className="flex-1 px-4 py-2.5 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm font-medium transition-colors">
                                        Annuler
                                    </button>
                                    <button type="submit" disabled={loading || !form.password || !form.confirmPassword} className="flex-1 flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl bg-primary-600 hover:bg-primary-700 text-white text-sm font-medium transition-colors disabled:opacity-50">
                                        {loading ? <Icon name="loader-2" size={14} className="animate-spin" /> : <Icon name="check" size={14} />}
                                        Confirmer
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        // ============================================
        // App Root
        // ============================================
        function parseHash() {
            const hash = window.location.hash.slice(1);
            if (!hash) return { page: 'dashboard', param: null };
            const [page, ...rest] = hash.split('/');
            const param = rest.length > 0 ? decodeURIComponent(rest.join('/')) : null;
            return { page, param };
        }

        function App() {
            // Charger l'utilisateur depuis localStorage au démarrage
            const [currentUser, setCurrentUser] = useState(() => {
                try {
                    const saved = localStorage.getItem('websftp_user');
                    return saved ? JSON.parse(saved) : null;
                } catch {
                    return null;
                }
            });
            const [pendingUser, setPendingUser] = useState(null);
            const initial = parseHash();
            const [page, setPage] = useState(initial.page);
            const [pageParam, setPageParam] = useState(initial.param);
            const [allProjects, setAllProjects] = useState([]);
            const [toast, setToast] = useState(null);

            const loadProjects = useCallback(async () => {
                const result = await api.get('/api/projects');
                if (result.success) setAllProjects(result.data || []);
            }, []);

            useEffect(() => { 
                if (currentUser) loadProjects(); 
            }, [loadProjects, currentUser]);

            // Auto-refresh every 15s
            useEffect(() => {
                if (!currentUser) return;
                const interval = setInterval(loadProjects, 15000);
                return () => clearInterval(interval);
            }, [loadProjects, currentUser]);

            useEffect(() => {
                function onHashChange() {
                    const { page: p, param } = parseHash();
                    setPage(p);
                    setPageParam(param);
                }
                window.addEventListener('hashchange', onHashChange);
                return () => window.removeEventListener('hashchange', onHashChange);
            }, []);

            function navigate(newPage, param = null) {
                const hash = param ? `${newPage}/${encodeURIComponent(param)}` : newPage;
                window.location.hash = hash;
            }

            function showToast(message, type = 'info') {
                setToast({ message, type });
            }

            function handleLogin(user) {
                if (user.mustChangePassword) {
                    setPendingUser(user);
                } else {
                    setCurrentUser(user);
                    // Sauvegarder dans localStorage pour persister la session
                    localStorage.setItem('websftp_user', JSON.stringify(user));
                    if (!window.location.hash || window.location.hash === '#') {
                        window.location.hash = 'dashboard';
                    }
                }
            }

            function handleLogout() {
                setCurrentUser(null);
                // Supprimer de localStorage lors de la déconnexion
                localStorage.removeItem('websftp_user');
                window.location.hash = 'dashboard';
                setAllProjects([]);
            }

            // Filtrer les projets selon le rôle de l'utilisateur
            const visibleProjects = currentUser?.role === 'admin' 
                ? allProjects 
                : allProjects.filter(p => currentUser?.projects?.includes(p.name));

            function renderPage() {
                const isAdmin = currentUser?.role === 'admin';
                
                switch (page) {
                    case 'dashboard':
                        return <DashboardPage projects={visibleProjects} onNavigate={navigate} onRefresh={loadProjects} showToast={showToast} currentUser={currentUser} />;
                    case 'projects':
                        return <ProjectsPage projects={visibleProjects} onNavigate={navigate} onRefresh={loadProjects} showToast={showToast} />;
                    case 'databases':
                        return <DatabasesPage onNavigate={navigate} showToast={showToast} currentUser={currentUser} />;
                    case 'database-editor':
                        return <DatabaseEditorPage databaseId={pageParam} onNavigate={navigate} showToast={showToast} />;
                    case 'create-project':
                        if (!isAdmin) return <DashboardPage projects={visibleProjects} onNavigate={navigate} onRefresh={loadProjects} showToast={showToast} currentUser={currentUser} />;
                        return <CreateProjectPage onNavigate={navigate} onRefresh={loadProjects} showToast={showToast} />;
                    case 'project-detail':
                        return <ProjectDetailPage projectName={pageParam} onNavigate={navigate} onRefresh={loadProjects} showToast={showToast} />;
                    case 'sftp-browser':
                        return <SFTPBrowserPage projectName={pageParam} onNavigate={navigate} showToast={showToast} />;
                    case 'users':
                        if (!isAdmin) return <DashboardPage projects={visibleProjects} onNavigate={navigate} onRefresh={loadProjects} showToast={showToast} currentUser={currentUser} />;
                        return <UsersManagementPage showToast={showToast} onNavigate={navigate} allProjects={allProjects} />;
                    case 'pm2':
                        if (!isAdmin) return <DashboardPage projects={visibleProjects} onNavigate={navigate} onRefresh={loadProjects} showToast={showToast} currentUser={currentUser} />;
                        return <PM2StatusPage showToast={showToast} />;
                    default:
                        return <DashboardPage projects={visibleProjects} onNavigate={navigate} onRefresh={loadProjects} showToast={showToast} currentUser={currentUser} />;
                }
            }

            if (!currentUser) {
                if (pendingUser) {
                    return <>
                        <ForceChangePasswordPage user={pendingUser} showToast={showToast} onDone={() => { const updatedUser = {...pendingUser, mustChangePassword: false}; setCurrentUser(updatedUser); localStorage.setItem('websftp_user', JSON.stringify(updatedUser)); setPendingUser(null); window.location.hash = 'dashboard'; }} onCancel={() => setPendingUser(null)} />
                        {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    </>;
                }
                return <>
                    <LoginPage onLogin={handleLogin} showToast={showToast} />
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                </>;
            }

            return (
                <div className="flex h-full">
                    <Sidebar currentPage={page} onNavigate={navigate} projectCount={visibleProjects.length} currentUser={currentUser} onLogout={handleLogout} />
                    <main className="flex-1 overflow-y-auto">
                        <div className="max-w-6xl mx-auto px-8 py-8">
                            {renderPage()}
                        </div>
                    </main>
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                </div>
            );
        }

        // Mount
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
